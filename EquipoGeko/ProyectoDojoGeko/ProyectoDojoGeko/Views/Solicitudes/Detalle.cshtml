@model ProyectoDojoGeko.Models.SolicitudViewModel
@{
    var tituloEstado = Model.Encabezado.Estado == 6 ? "Solicitud Rechazada" : 
                       Model.Encabezado.Estado == 2 ? "Solicitud Autorizada" : 
                       "Detalle de Solicitud";
    ViewData["Title"] = $"{tituloEstado} - GEKO Sistemas de Seguridad";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
    var empleado = ViewBag.Empleado;
    var idAutorizador = Context.Session.GetInt32("IdEmpleado") ?? 0;
}

<link rel="stylesheet" href="~/css/empleado-detalle.css" />
<link rel="stylesheet" href="~/css/detalle-solicitud.css" />

<div class="empleado-detalle-container" id="contenido-pdf">
    <!-- Encabezado -->
    <div class="page-header">
        <div class="header-content">
            <h1 class="page-title">
                @if (Model.Encabezado.Estado == 6)
                {
                    <i class="fas fa-times-circle" style="color: #DC2626;"></i>
                    <span>Solicitud Rechazada</span>
                }
                else if (Model.Encabezado.Estado == 2)
                {
                    <i class="fas fa-check-circle" style="color: #16A34A;"></i>
                    <span>Solicitud Autorizada</span>
                }
                else
                {
                    <i class="fas fa-id-card icon-naranja"></i>
                    <span>Detalle de Solicitud</span>
                }
            </h1>
            <p class="page-subtitle">Información detallada sobre la solicitud de vacaciones</p>
        </div>
    </div>

    @* Mensajes de éxito o error *@
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert" style="margin-bottom: 20px; background: #D1FAE5; border-left: 4px solid #10B981; color: #065F46; padding: 20px; font-size: 18px;">
            <h4 style="margin: 0 0 10px 0; color: #065F46;">
                <i class="fas fa-check-circle"></i> ¡Operación Exitosa!
            </h4>
            <p style="margin: 0; font-size: 16px;">@TempData["SuccessMessage"]</p>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["MensajeError"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert" style="margin-bottom: 20px; background: #FEE2E2; border-left: 4px solid #DC2626; color: #991B1B;">
            <i class="fas fa-exclamation-circle"></i> @TempData["MensajeError"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    
    @* Alerta especial si la solicitud está rechazada *@
    @if (Model.Encabezado.Estado == 6 && !string.IsNullOrEmpty(Model.Encabezado.MotivoRechazo))
    {
        <div class="alert alert-warning" role="alert" style="margin-bottom: 20px; background: #FEF3C7; border-left: 4px solid #F59E0B; color: #92400E;">
            <h5 style="margin: 0 0 0.5rem 0; color: #92400E;">
                <i class="fas fa-exclamation-triangle"></i> Esta solicitud fue rechazada
            </h5>
            <p style="margin: 0;">El autorizador ha rechazado tu solicitud. Revisa el motivo en la sección inferior.</p>
        </div>
    }

    <div class="empleado-card">
        <!-- Tarjeta de resumen -->
        <div class="info-box">
            <h2 class="empleado-nombre-s">@Model.Encabezado.NombreEmpleado</h2>
            <p class="empleado-id">Número de solicitud: <strong>@Model.Encabezado.IdSolicitud</strong></p>
            <div class="estado-box">
                <span class="badge estado-@Model.Encabezado.Estado">
                    <i class="fas fa-info-circle"></i> @Model.Encabezado.Estado
                </span>
            </div>
            <div class="detalle-mini-grid">
                <div class="stat-item">
                    <div class="stat-label">Días solicitados</div>
                    <div class="stat-value">@Model.Encabezado.DiasSolicitadosTotal días</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Fecha de creación</div>
                    <div class="stat-value">@Model.Encabezado.FechaIngresoSolicitud.ToString("dd/MM/yyyy")</div>
                </div>
            </div>
        </div>

        <!-- Información del Empleado -->
        <div class="info-section">
            <div class="section-header">

        <!-- Tabla de fechas -->
        <div class="info-section">
            <div class="section-header">
                <h3 class="section-title">
                    <i class="fas fa-calendar-alt icon-naranja"></i> Fechas Solicitadas
                </h3>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-bordered text-center align-middle tabla-fechas-solicitadas">
                    <thead class="table-light">
                        <tr>
                            <th>Fecha Inicio</th>
                            <th>Fecha Fin</th>
                            <th>Días Hábiles</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var d in Model.Detalles)
                        {
                            <tr>
                                <td>@d.FechaInicio.ToString("dd/MM/yyyy")</td>
                                <td>@d.FechaFin.ToString("dd/MM/yyyy")</td>
                                <td>@d.DiasHabilesTomados</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Vista Previa del PDF con Firma del Empleado -->
        <div class="info-section">
            <div class="section-header">
                <h3 class="section-title">
                    <i class="fas fa-file-pdf icon-naranja"></i> Vista Previa del Documento con Firma del Empleado
                </h3>
            </div>
            <div class="pdf-preview-container">
                <iframe id="pdfPreview" 
                        src="@Url.Action("VisualizarPDF", "Solicitudes", new { idSolicitud = Model.Encabezado.IdSolicitud })" 
                        style="width: 100%; height: 800px; border: 2px solid #ddd; border-radius: 8px;">
                </iframe>
            </div>
        </div>
    </div>

    <!-- Acciones de Autorización -->
    <div class="acciones-box">
        @if (Model.Encabezado.Estado == 1)
        {
            <div class="acciones-titulo">
                <i class="fas fa-tasks"></i> Acciones del Autorizador
            </div>

@*             <div class="firma-info-box">
                <i class="fas fa-info-circle"></i>
                <p>
                    Al autorizar esta solicitud, su firma registrada se agregará automáticamente al documento.
                    <a href="@Url.Action("MiFirma", "Firmas")" target="_blank" style="color: #2196F3; font-weight: bold;">
                        <i class="fas fa-pen-fancy"></i> Gestionar mi firma
                    </a>
                </p>
            </div> *@
            
            <div class="botones-container">
                <form asp-action="AutorizarSolicitud" method="post" class="inline-form" id="formAutorizar">
                    <input type="hidden" name="idSolicitud" value="@Model.Encabezado.IdSolicitud" />
                    <button type="button" class="btn btn-success boton-accion-grande" id="btnMostrarModalAutorizar">
                        <i class="fas fa-check-circle"></i> Autorizar Solicitud
                    </button>
                </form>

                <form asp-action="Rechazar" method="post" class="inline-form" id="formRechazar">
                    <input type="hidden" name="idSolicitud" value="@Model.Encabezado.IdSolicitud" />
                    <input type="hidden" name="idAutorizador" value="@idAutorizador" />
                    <input type="hidden" name="observaciones" id="observacionesRechazo" value="" />
                    <button type="button" class="btn btn-danger boton-accion-grande" id="btnMostrarModalRechazar">
                        <i class="fas fa-times-circle"></i> Rechazar Solicitud
                    </button>
                </form>

                <a href="@Url.Action("Autorizar", "Solicitudes")" class="btn btn-secondary boton-accion-grande">
                    <i class="fas fa-arrow-left"></i> Volver a Lista
                </a>
            </div>
        }
        else
        {
            <div class="botones-container" style="justify-content: center;">
                <a href="@Url.Action("Autorizar", "Solicitudes")" class="btn btn-secondary boton-accion-grande">
                    <i class="fas fa-arrow-left"></i> Volver a Lista
                </a>
            </div>
        }
    </div>
</div>

<!-- Sección de Observaciones/Motivo del Rechazo (fuera del PDF) -->
@if (Model.Encabezado.Estado == 6 && !string.IsNullOrEmpty(Model.Encabezado.MotivoRechazo))
{
    <div class="empleado-detalle-container" style="margin-top: 20px;">
        <div class="empleado-card" style="border-left: 4px solid #DC2626; background: linear-gradient(135deg, #FEE2E2, #FECACA);">
            <div class="info-section">
                <div class="section-header" style="border-bottom: 2px solid #DC2626;">
                    <h3 class="section-title" style="color: #991B1B;">
                        <i class="fas fa-exclamation-triangle" style="color: #DC2626;"></i> Motivo del Rechazo
                    </h3>
                </div>
                <div style="padding: 20px; background: white; border-radius: 8px; margin-top: 15px;">
                    <p style="margin: 0; color: #7F1D1D; font-size: 16px; line-height: 1.6;">
                        <strong>Observaciones del autorizador:</strong><br>
                        @Model.Encabezado.MotivoRechazo
                    </p>
                </div>
            </div>
        </div>
    </div>
}

<!-- Modal para visualizar el documento -->
<div id="verDocumentoModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; padding:20px; box-sizing:border-box;">
    <div style="width:100%; max-width:1000px; margin:20px auto; background:#fff; border-radius:8px; overflow:hidden; display:flex; flex-direction:column; height:calc(100% - 40px);">
        <div style="padding:15px 20px; background:#003C9D; color:white; display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0; font-size:1.2em;">Documento Firmado</h3>
            <button id="closePdfModal" style="background:none; border:none; color:white; font-size:1.5em; cursor:pointer;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div style="flex:1; padding:0; overflow:hidden;">
            <!-- Usamos iframe en lugar de object -->
            <iframe id="pdfViewer" src="" type="application/pdf" style="width:100%; height:100%; min-height:500px; border:none;"></iframe>
        </div>
        <div style="padding:15px 20px; background:#f5f5f5; display:flex; justify-content:flex-end; gap:10px;">
            <button id="btnDescargar" class="btn btn-primary">
                <i class="fas fa-download"></i> Descargar
            </button>
            <button id="closePdfModalBtn" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cerrar
            </button>
        </div>
    </div>
</div>

<!-- Modal para Rechazar Solicitud -->
<div class="modal fade" id="modalRechazarSolicitud" tabindex="-1" role="dialog" aria-labelledby="modalRechazarLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content modal-rechazo">
      
      <div class="modal-header modal-rechazo__header">
        <h5 class="modal-title" id="modalRechazarLabel">
          <i class="fas fa-exclamation-triangle"></i>
          Rechazar Solicitud
        </h5>

@*         <button type="button" class="close modal-rechazo__close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button> *@
      </div>

      <div class="modal-body modal-rechazo__body">
        <div class="modal-rechazo__alert">
          <i class="fas fa-info-circle"></i>
          <div>
            <strong>Importante:</strong> Esta acción rechazará la solicitud de vacaciones. El empleado será notificado del rechazo.
          </div>
        </div>

        <div class="form-group mb-0">
          <label for="motivoRechazoInput" class="modal-rechazo__label">
            <i class="fas fa-comment-dots"></i>
            Motivo del Rechazo <span>*</span>
          </label>

          <textarea
            maxlength="150"
            class="form-control modal-rechazo__textarea"
            id="motivoRechazoInput"
            rows="5"
            placeholder="Explique detalladamente el motivo por el cual se rechaza esta solicitud de vacaciones..."
            required
          ></textarea>
        </div>
      </div>

      <div class="modal-footer modal-rechazo__footer">
        <button type="button" class="btn btn-secondary modal-rechazo__btn" data-dismiss="modal">
          <i class="fas fa-times"></i> Cancelar
        </button>
        <button type="button" class="btn btn-primary modal-rechazo__btn modal-rechazo__btn--primary" id="btnConfirmarRechazo">
          <i class="fas fa-ban"></i> Confirmar Rechazo
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Autorizar Solicitud -->
<div class="modal fade" id="modalAutorizarSolicitud" tabindex="-1" role="dialog" aria-labelledby="modalAutorizarLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content modal-autorizar">
      
      <div class="modal-header modal-autorizar__header">
        <h5 class="modal-title" id="modalAutorizarLabel">
          <i class="fas fa-check-circle"></i>
          Autorizar Solicitud
        </h5>

@*         <button type="button" class="close modal-autorizar__close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button> *@
      </div>

      <div class="modal-body modal-autorizar__body">
        <div class="modal-autorizar__alert">
          <i class="fas fa-info-circle"></i>
          <div>
            <strong>¿Está seguro de autorizar esta solicitud?</strong>
            <p>Al confirmar, su firma registrada se agregará automáticamente al documento PDF y el empleado será notificado.</p>
          </div>
        </div>

        <div class="modal-autorizar__info">
          <div class="info-item">
            <i class="fas fa-user"></i>
            <span><strong>Empleado:</strong> @Model.Encabezado.NombreEmpleado</span>
          </div>
          <div class="info-item">
            <i class="fas fa-calendar-alt"></i>
            <span><strong>Días solicitados:</strong> @Model.Encabezado.DiasSolicitadosTotal</span>
          </div>
        </div>
      </div>

      <div class="modal-footer modal-autorizar__footer">
        <button type="button" class="btn btn-secondary modal-autorizar__btn" data-dismiss="modal">
          <i class="fas fa-times"></i> Cancelar
        </button>
        <button type="button" class="btn btn-success modal-autorizar__btn modal-autorizar__btn--primary" id="btnConfirmarAutorizar">
          <i class="fas fa-check-circle"></i> Confirmar Autorización
        </button>
      </div>
    </div>
  </div>
</div>


@section Styles {
    <link rel="stylesheet" href="~/css/empresas.css" />
    <link rel="stylesheet" href="~/css/detalle-solicitud.css" />
}

<style>
    .pdf-preview-container {
        margin-top: 1rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        border-radius: 8px;
        overflow: hidden;
    }

    /* Estilos para el modal de rechazo */
            /* ===== Fix layout: todo en columna, textarea full width ===== */
            #modalRechazarSolicitud .modal-body {
                padding: 22px !important;
                display: flex;
                flex-direction: column;
                gap: 16px;
            }

                /* Caja "Importante" (si la tienes como div con fondo) */
                #modalRechazarSolicitud .modal-body > div {
                    width: 100%;
                }

            #modalRechazarSolicitud .modal-dialog {
                max-width: 480px; /* tamaño ideal */
                width: 100%;
                margin: 1.75rem auto; /* centrado horizontal */
            }

            /* Forzar que form-group no sea row/inline */
            #modalRechazarSolicitud .form-group {
                margin: 0 !important;
                display: flex;
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

                /* Label arriba, no a la par */
                #modalRechazarSolicitud .form-group label {
                    display: flex !important;
                    align-items: center;
                    gap: 8px;
                    margin: 0 !important;
                    font-weight: 700;
                    color: #374151;
                }

                /* Textarea SIEMPRE debajo y a lo ancho */
                #modalRechazarSolicitud .form-group textarea,
                #modalRechazarSolicitud textarea.form-control {
                    width: 100% !important;
                    max-width: 100% !important;
                    min-height: 140px;
                    border-radius: 12px;
                    border: 2px solid #E5E7EB;
                    padding: 12px 14px;
                    resize: vertical;
                    box-sizing: border-box;
                }

                    /* Focus bonito */
                    #modalRechazarSolicitud textarea.form-control:focus {
                        border-color: #BD452A;
                        box-shadow: 0 0 0 .2rem rgba(37, 99, 235, .18);
                        outline: none;
                    }

            /* Alert centrada y legible */
            #modalRechazarSolicitud .modal-body p {
                margin: 0;
                line-height: 1.5;
            }

            /* Footer ordenado */
            #modalRechazarSolicitud .modal-footer {
                display: flex;
                justify-content: center;
                gap: 10px;
                padding: 16px 22px;
                background: #F9FAFB;
                border-top: 1px solid #E5E7EB;
            }

                /* Botones consistentes */
                #modalRechazarSolicitud .modal-footer .btn {
                    border-radius: 12px;
                    padding: 10px 16px;
                    font-weight: 700;
                    display: inline-flex;
                    align-items: center;
                    gap: 8px;
                }

            #modalRechazarSolicitud .modal-title {
                font-size: 1.4rem;
                font-weight: 700;
                display: flex;
                align-items: center;
                gap: 12px;
            }
            /* Primario con gradiente */
            #modalRechazarSolicitud .btn-primary {
                border: 0;
                background: linear-gradient(135deg, #BD452A 0%, #A61E00 100%);
            }

            /* Hover suaves */
            #modalRechazarSolicitud .btn:hover {
                transform: translateY(-1px);
                box-shadow: 0 8px 18px rgba(0,0,0,.12);
            }

            /* Header limpio */
            #modalRechazarSolicitud .modal-header {
                padding: 18px 22px;
                border: 0;
                background: linear-gradient(135deg, #BD452A 0%, #A61E00 100%);
                color: #fff;
            }


                /* X */
                #modalRechazarSolicitud .modal-header .close {
                    color: #fff;
                    opacity: .95;
                    font-size: 1.8rem;
                    line-height: 1;
                    margin: 0;
                    padding: 0;
                    transition: transform .2s ease, opacity .2s ease;
                    background: #A61E00;
                }

                    #modalRechazarSolicitud .modal-header .close:hover {
                        transform: rotate(90deg);
                        opacity: 1;
                    }

    /* ===== MODAL AUTORIZAR ===== */
    #modalAutorizarSolicitud .modal-dialog {
        max-width: 500px;
        width: 100%;
        margin: 1.75rem auto;
    }

    #modalAutorizarSolicitud .modal-body {
        padding: 24px;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    #modalAutorizarSolicitud .modal-header {
        padding: 20px 24px;
        border: 0;
        background: linear-gradient(135deg, #10B981 0%, #059669 100%);
        color: #fff;
    }

    #modalAutorizarSolicitud .modal-title {
        font-size: 1.4rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    #modalAutorizarSolicitud .modal-header .close {
        color: #fff;
        opacity: .95;
        font-size: 1.8rem;
        line-height: 1;
        margin: 0;
        padding: 0;
        transition: transform .2s ease, opacity .2s ease;
    }

    #modalAutorizarSolicitud .modal-header .close:hover {
        transform: rotate(90deg);
        opacity: 1;
    }

    .modal-autorizar__alert {
        background: #D1FAE5;
        border-left: 4px solid #10B981;
        padding: 16px;
        border-radius: 8px;
        display: flex;
        gap: 12px;
        align-items: flex-start;
    }

    .modal-autorizar__alert i {
        color: #059669;
        font-size: 1.3rem;
        margin-top: 2px;
    }

    .modal-autorizar__alert strong {
        color: #065F46;
        display: block;
        margin-bottom: 6px;
    }

    .modal-autorizar__alert p {
        margin: 0;
        color: #047857;
        font-size: 0.95rem;
        line-height: 1.5;
    }

    .modal-autorizar__info {
        background: #F9FAFB;
        border-radius: 8px;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .modal-autorizar__info .info-item {
        display: flex;
        align-items: center;
        gap: 10px;
        color: #374151;
    }

    .modal-autorizar__info .info-item i {
        color: #10B981;
        font-size: 1.1rem;
        width: 20px;
    }

    #modalAutorizarSolicitud .modal-footer {
        display: flex;
        justify-content: center;
        gap: 12px;
        padding: 16px 24px;
        background: #F9FAFB;
        border-top: 1px solid #E5E7EB;
    }

    #modalAutorizarSolicitud .modal-footer .btn {
        border-radius: 8px;
        padding: 10px 20px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
    }

    #modalAutorizarSolicitud .btn-success {
        border: 0;
        background: linear-gradient(135deg, #10B981 0%, #059669 100%);
    }

    #modalAutorizarSolicitud .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0,0,0,.15);
    }


    .acciones-box {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1.5rem;
        margin-top: 2rem;
        padding: 2rem;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        border-top: 3px solid #002244;
        border-radius: 0 0 12px 12px;
        box-shadow: 0 -4px 6px rgba(0,0,0,0.1);
    }

    .acciones-titulo {
        font-size: 1.3rem;
        font-weight: bold;
        color: #002244;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .acciones-titulo i {
        font-size: 1.5rem;
    }

    .firma-info-box {
        background: #e3f2fd;
        border-left: 4px solid #2196F3;
        padding: 1rem 1.5rem;
        margin: 1rem 0;
        border-radius: 4px;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .firma-info-box i {
        font-size: 1.5rem;
        color: #2196F3;
    }

    .firma-info-box p {
        margin: 0;
        color: #333;
        line-height: 1.6;
    }

    .botones-container {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        justify-content: center;
        align-items: center;
    }

    .inline-form {
        display: inline-block;
    }

    .boton-accion {
        padding: 0.6rem 1.5rem;
        font-size: 1rem;
        border-radius: 8px;
        min-width: 140px;
        transition: all 0.3s ease;
    }

        .boton-accion i {
            margin-right: 8px;
        }

    .boton-accion-grande {
        padding: 1rem 2.5rem;
        font-size: 1.1rem;
        font-weight: bold;
        border-radius: 10px;
        min-width: 220px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }

        .boton-accion-grande:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .boton-accion-grande i {
            margin-right: 10px;
            font-size: 1.2rem;
        }

    .tabla-fechas-solicitadas td, .tabla-fechas-solicitadas th {
        padding: 1rem !important;
        font-size: 1rem;
    }

    /* Notificación de éxito */
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 5px;
        color: white;
        font-weight: bold;
        z-index: 9999;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
    }

        .notification.success {
            background-color: #28a745;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
</style>

<!-- Scripts para PDF - Usando pdfMake -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

<script>
    // Datos de la solicitud para JavaScript
    const solicitudData = {
        idSolicitud: @Model.Encabezado.IdSolicitud,
        nombreEmpleado: '@Html.Raw(Model.Encabezado.NombreEmpleado)',
        codigoEmpleado: '@Html.Raw(empleado?.CodigoEmpleado ?? "")',
        departamento: '@Html.Raw(empleado?.Departamento ?? "")',
        puesto: '@Html.Raw(empleado?.Puesto ?? "")',
        fechaIngreso: '@(empleado?.FechaIngreso?.ToString("dd/MM/yyyy") ?? "")',
        correo: '@Html.Raw(empleado?.CorreoInstitucional ?? "")',
        telefono: '@Html.Raw(empleado?.Telefono ?? "")',
        fechaSolicitud: '@Model.Encabezado.FechaIngresoSolicitud.ToString("dd/MM/yyyy")',
        diasSolicitados: @Model.Encabezado.DiasSolicitadosTotal,
        estado: '@Html.Raw(Model.Encabezado.Estado)',
        detalles: [
            @foreach (var detalle in Model.Detalles)
            {
                    <text>{
                        fechaInicio: '@detalle.FechaInicio.ToString("dd/MM/yyyy")',
                        fechaFin: '@detalle.FechaFin.ToString("dd/MM/yyyy")',
                        diasHabiles: @detalle.DiasHabilesTomados
                    },</text>
            }
        ]
    };

    function generarPDF() {
        console.log('Iniciando generación de PDF con pdfMake...');

        // Cambiar texto del botón
        const btnPdf = document.getElementById('btn-pdf');
        const pdfText = document.getElementById('pdf-text');
        const textoOriginal = pdfText.textContent;

        pdfText.textContent = 'Generando...';
        btnPdf.disabled = true;

        // Función para restaurar botón
        function restaurarBoton() {
            pdfText.textContent = textoOriginal;
            btnPdf.disabled = false;
        }

        // Verificar que pdfMake esté disponible
        if (typeof pdfMake === 'undefined') {
            alert('Error: No se pudo cargar la librería PDF. Verifique su conexión a internet.');
            restaurarBoton();
            return;
        }

        try {
            // Crear filas de la tabla de detalles
            const filasTabla = [
                // Cabecera de la tabla
                [
                    { text: 'Fecha Inicio', style: 'tableHeader' },
                    { text: 'Fecha Fin', style: 'tableHeader' },
                    { text: 'Días Hábiles', style: 'tableHeader' }
                ]
            ];

            // Agregar filas de datos
            solicitudData.detalles.forEach(detalle => {
                filasTabla.push([
                    { text: detalle.fechaInicio, style: 'tableCell' },
                    { text: detalle.fechaFin, style: 'tableCell' },
                    { text: detalle.diasHabiles.toString(), style: 'tableCell', alignment: 'center' }
                ]);
            });

            // Definición del documento PDF - VERSIÓN MEJORADA
            const docDefinition = {
                pageSize: 'A4',
                pageMargins: [40, 40, 40, 40],

                content: [
                    // Título principal - con colores más fuertes
                    {
                        text: 'Detalle de Solicitud',
                        style: 'mainTitle',
                        margin: [0, 0, 0, 8]
                    },

                    // Subtítulo - con color más fuerte
                    {
                        text: 'Información detallada sobre la solicitud de vacaciones',
                        style: 'subtitle',
                        margin: [0, 0, 0, 20]
                    },

                    // Número de solicitud - con color más fuerte
                    {
                        text: `Número de solicitud: ${solicitudData.idSolicitud}`,
                        style: 'solicitudNumber',
                        margin: [0, 0, 0, 25]
                    },

                    // Sección de días solicitados y fecha - mejorada
                    {
                        table: {
                            widths: ['50%', '50%'],
                            body: [
                                [
                                    {
                                        stack: [
                                            { text: 'Días solicitados', style: 'statLabel', alignment: 'center' },
                                            { text: `${solicitudData.diasSolicitados} días`, style: 'statValue', alignment: 'center' }
                                        ],
                                        border: [false, false, false, false]
                                    },
                                    {
                                        stack: [
                                            { text: 'Fecha de creación', style: 'statLabel', alignment: 'center' },
                                            { text: solicitudData.fechaSolicitud, style: 'statValue', alignment: 'center' }
                                        ],
                                        border: [false, false, false, false]
                                    }
                                ]
                            ]
                        },
                        layout: 'noBorders',
                        margin: [0, 0, 0, 30]
                    },

                    // Título "Información del Empleado" - mejorado
                    {
                        text: 'Información del Empleado',
                        style: 'sectionTitle',
                        margin: [0, 0, 0, 20]
                    },

                    // Grid de información del empleado - mejorado
                    {
                        table: {
                            widths: ['33%', '33%', '34%'],
                            body: [
                                [
                                    {
                                        stack: [
                                            { text: 'Código', style: 'fieldLabel' },
                                            { text: solicitudData.codigoEmpleado, style: 'fieldValue' }
                                        ],
                                        border: [false, false, false, false],
                                        margin: [0, 0, 10, 15]
                                    },
                                    {
                                        stack: [
                                            { text: 'Departamento', style: 'fieldLabel' },
                                            { text: solicitudData.departamento, style: 'fieldValue' }
                                        ],
                                        border: [false, false, false, false],
                                        margin: [0, 0, 10, 15]
                                    },
                                    {
                                        stack: [
                                            { text: 'Puesto', style: 'fieldLabel' },
                                            { text: solicitudData.puesto, style: 'fieldValue' }
                                        ],
                                        border: [false, false, false, false],
                                        margin: [0, 0, 0, 15]
                                    }
                                ],
                                [
                                    {
                                        stack: [
                                            { text: 'Fecha de Ingreso', style: 'fieldLabel' },
                                            { text: solicitudData.fechaIngreso, style: 'fieldValue' }
                                        ],
                                        border: [false, false, false, false],
                                        margin: [0, 0, 10, 0]
                                    },
                                    {
                                        stack: [
                                            { text: 'Correo', style: 'fieldLabel' },
                                            { text: solicitudData.correo, style: 'fieldValue' }
                                        ],
                                        border: [false, false, false, false],
                                        margin: [0, 0, 10, 0]
                                    },
                                    {
                                        stack: [
                                            { text: 'Teléfono', style: 'fieldLabel' },
                                            { text: solicitudData.telefono, style: 'fieldValue' }
                                        ],
                                        border: [false, false, false, false],
                                        margin: [0, 0, 0, 0]
                                    }
                                ]
                            ]
                        },
                        layout: 'noBorders',
                        margin: [0, 0, 0, 30]
                    },

                    // Título "Fechas Solicitadas" - mejorado
                    {
                        text: 'Fechas Solicitadas',
                        style: 'sectionTitle',
                        margin: [0, 0, 0, 20]
                    },

                    // Tabla de fechas - mejorada
                    {
                        table: {
                            headerRows: 1,
                            widths: ['*', '*', '*'],
                            body: filasTabla
                        },
                        layout: {
                            hLineWidth: function (i, node) {
                                return (i === 0 || i === node.table.body.length) ? 2 : 1;
                            },
                            vLineWidth: function (i, node) {
                                return (i === 0 || i === node.table.widths.length) ? 2 : 1;
                            },
                            hLineColor: function (i, node) {
                                return (i === 0 || i === node.table.body.length) ? '#2c3e50' : '#bdc3c7';
                            },
                            vLineColor: function (i, node) {
                                return (i === 0 || i === node.table.widths.length) ? '#2c3e50' : '#bdc3c7';
                            },
                            fillColor: function (rowIndex, node, columnIndex) {
                                return (rowIndex === 0) ? '#ecf0f1' : (rowIndex % 2 === 0 ? '#f8f9fa' : null);
                            },
                            paddingLeft: function(i, node) { return 8; },
                            paddingRight: function(i, node) { return 8; },
                            paddingTop: function(i, node) { return 8; },
                            paddingBottom: function(i, node) { return 8; }
                        },
                        margin: [0, 0, 0, 20]
                    }
                ],

                styles: {
                    mainTitle: {
                        fontSize: 22,
                        bold: true,
                        color: '#2c3e50'  // Azul oscuro fuerte
                    },
                    subtitle: {
                        fontSize: 13,
                        color: '#34495e',  // Gris azulado fuerte
                        italics: true
                    },
                    solicitudNumber: {
                        fontSize: 12,
                        color: '#2c3e50',  // Azul oscuro fuerte
                        bold: true
                    },
                    statLabel: {
                        fontSize: 11,
                        color: '#7f8c8d',  // Gris fuerte
                        margin: [0, 0, 0, 5]
                    },
                    statValue: {
                        fontSize: 16,
                        bold: true,
                        color: '#e74c3c'  // Rojo fuerte para destacar
                    },
                    sectionTitle: {
                        fontSize: 16,
                        bold: true,
                        color: '#2980b9',  // Azul fuerte
                        decoration: 'underline'
                    },
                    fieldLabel: {
                        fontSize: 11,
                        color: '#3498db',  // Azul brillante fuerte
                        bold: true,
                        margin: [0, 0, 0, 3]
                    },
                    fieldValue: {
                        fontSize: 11,
                        color: '#2c3e50'  // Azul oscuro fuerte
                    },
                    tableHeader: {
                        fontSize: 12,
                        bold: true,
                        color: '#2c3e50',  // Azul oscuro fuerte
                        alignment: 'center'
                    },
                    tableCell: {
                        fontSize: 11,
                        color: '#34495e',  // Gris azulado fuerte
                        alignment: 'center'
                    }
                }
            };

            // Generar y descargar el PDF
            pdfMake.createPdf(docDefinition).download(`Solicitud_Vacaciones_${solicitudData.idSolicitud}_${new Date().toISOString().slice(0, 10)}.pdf`);

            // Mostrar notificación de éxito
            mostrarNotificacion("Archivo PDF exportado exitosamente", "success");

            // Restaurar botón
            restaurarBoton();

        } catch (error) {
            console.error('Error al generar PDF:', error);
            alert('Error al generar el PDF: ' + error.message);
            restaurarBoton();
        }
    }

    // Función para mostrar notificaciones
    function mostrarNotificacion(mensaje, tipo) {
        // Crear elemento de notificación
        const notification = document.createElement('div');
        notification.className = `notification ${tipo}`;
        notification.textContent = mensaje;

        // Agregar al DOM
        document.body.appendChild(notification);

        // Mostrar con animación
        setTimeout(() => {
            notification.classList.add('show');
        }, 100);

        // Ocultar después de 3 segundos
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 3000);
    }

    // Función para abrir el modal del documento
    function abrirModalDocumento(idSolicitud) {
        const modal = document.getElementById("verDocumentoModal");
        const pdfViewer = document.getElementById("pdfViewer");

        // Aquí cargamos el PDF directamente desde el controlador
        pdfViewer.src = `/Solicitudes/VerDocumento?idSolicitud=${idSolicitud}`;

        modal.style.display = "block";
        document.body.style.overflow = "hidden";
    }

    // Cerrar modal al hacer clic en la X
    document.getElementById('closePdfModal')?.addEventListener('click', function() {
        const modal = document.getElementById('verDocumentoModal');
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    });

    // Cerrar modal al hacer clic en el botón Cerrar
    document.getElementById('closePdfModalBtn')?.addEventListener('click', function() {
        const modal = document.getElementById('verDocumentoModal');
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    });

    // Cerrar modal al hacer clic fuera del contenido
    document.getElementById('verDocumentoModal')?.addEventListener('click', function(e) {
        if (e.target === this) {
            this.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    });

    // Cerrar con tecla ESC
    document.addEventListener('keydown', function(e) {
        const modal = document.getElementById('verDocumentoModal');
        if (e.key === 'Escape' && modal.style.display === 'block') {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    });

    // Verificar carga de librerías al cargar la página
    document.addEventListener('DOMContentLoaded', function() {
        console.log('=== VERIFICANDO LIBRERÍAS ===');
        console.log('jQuery disponible:', typeof $ !== 'undefined');
        console.log('Bootstrap disponible:', typeof bootstrap !== 'undefined');
        console.log('pdfMake disponible:', typeof pdfMake !== 'undefined');
        
        if (typeof $ !== 'undefined' && $.fn.modal) {
            console.log('✅ jQuery modal disponible');
        } else {
            console.warn('⚠️ jQuery modal NO disponible');
        }

        if (typeof pdfMake !== 'undefined') {
            console.log('✅ pdfMake cargado correctamente');
        } else {
            console.error('❌ pdfMake NO está disponible');
        }

        // Manejar el modal del visor de PDF
        const verDocumentoBtn = document.querySelector('[data-bs-target="#verDocumentoModal"]');
        const verDocumentoModal = document.getElementById('verDocumentoModal');
        const closePdfModal = document.getElementById('closePdfModal');
        const closePdfModalBtn = document.getElementById('closePdfModalBtn');

        if (verDocumentoBtn) {
            verDocumentoBtn.addEventListener('click', function(e) {
                e.preventDefault();
                verDocumentoModal.style.display = 'block';
                document.body.style.overflow = 'hidden'; // Evitar scroll del body
            });
        }

        // Cerrar modal al hacer clic en la X
        if (closePdfModal) {
            closePdfModal.addEventListener('click', function() {
                verDocumentoModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            });
        }

        // Cerrar modal al hacer clic en el botón Cerrar
        if (closePdfModalBtn) {
            closePdfModalBtn.addEventListener('click', function() {
                verDocumentoModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            });
        }

        // Cerrar modal al hacer clic fuera del contenido
        verDocumentoModal.addEventListener('click', function(e) {
            if (e.target === verDocumentoModal) {
                verDocumentoModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        });

        // Cerrar con tecla ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && verDocumentoModal.style.display === 'block') {
                verDocumentoModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        });
    });

    // Función para confirmar rechazo con observaciones
    let formRechazoActual = null;
    
    function confirmarRechazo(event) {
        event.preventDefault();
        formRechazoActual = event.target;
        
        // Limpiar el textarea
        const textarea = document.getElementById('motivoRechazoInput');
        if (textarea) {
            textarea.value = '';
            // Limpiar errores previos
            const errorMsg = document.getElementById('errorMotivoRechazo');
            if (errorMsg) {
                errorMsg.remove();
            }
            textarea.style.borderColor = '#E5E7EB';
            textarea.style.boxShadow = 'none';
        }
        
        // Mostrar el modal usando Bootstrap nativo
        const modal = document.getElementById('modalRechazarSolicitud');
        if (modal) {
            // Si Bootstrap está disponible
            if (typeof bootstrap !== 'undefined') {
                const bsModal = new bootstrap.Modal(modal);
                bsModal.show();
            } else if (typeof $ !== 'undefined' && $.fn.modal) {
                // Si jQuery está disponible
                $(modal).modal('show');
            } else {
                // Fallback: mostrar manualmente
                // Crear backdrop primero
                const backdrop = document.createElement('div');
                backdrop.className = 'modal-backdrop fade show';
                backdrop.id = 'modalBackdrop';
                backdrop.onclick = cerrarModal;
                document.body.appendChild(backdrop);
                
                // Mostrar modal
                modal.style.display = 'block';
                modal.classList.add('show');
                document.body.classList.add('modal-open');
                
                // Centrar el modal verticalmente
                setTimeout(function() {
                    const dialog = modal.querySelector('.modal-dialog');
                    if (dialog) {
                        const windowHeight = window.innerHeight;
                        const dialogHeight = dialog.offsetHeight;
                        const topMargin = Math.max((windowHeight - dialogHeight) / 2, 30);
                        dialog.style.marginTop = topMargin + 'px';
                    }
                }, 10);
            }
        }
        
        return false;
    }
    
    // Función para cerrar el modal
    function cerrarModal() {
        const modal = document.getElementById('modalRechazarSolicitud');
        if (modal) {
            if (typeof bootstrap !== 'undefined') {
                const bsModal = bootstrap.Modal.getInstance(modal);
                if (bsModal) {
                    bsModal.hide();
                }
            } else if (typeof $ !== 'undefined' && $.fn.modal) {
                $(modal).modal('hide');
            } else {
                // Fallback: cerrar manualmente
                modal.style.display = 'none';
                modal.classList.remove('show');
                document.body.classList.remove('modal-open');
                
                // Remover backdrop
                const backdrop = document.getElementById('modalBackdrop');
                if (backdrop) {
                    backdrop.remove();
                }
            }
        }
    }
    
    // Esperar a que el DOM esté listo
    document.addEventListener('DOMContentLoaded', function() {
        // Manejar el botón de confirmar rechazo en el modal
        const btnConfirmar = document.getElementById('btnConfirmarRechazo');
        if (btnConfirmar) {
            btnConfirmar.addEventListener('click', function() {
                const motivo = document.getElementById('motivoRechazoInput').value.trim();
                
                // Validar que se haya ingresado un motivo
                if (!motivo) {
                    // Agregar efecto de error al textarea
                    const textarea = document.getElementById('motivoRechazoInput');
                    textarea.style.borderColor = '#2563EB';
                    textarea.style.boxShadow = '0 0 0 3px rgba(37, 99, 235, 0.1)';
                    textarea.focus();
                    
                    // Mostrar mensaje de error
                    if (!document.getElementById('errorMotivoRechazo')) {
                        const errorMsg = document.createElement('div');
                        errorMsg.id = 'errorMotivoRechazo';
                        errorMsg.style.cssText = 'color: #2563EB; font-size: 0.875rem; margin-top: 8px; font-weight: 500;';
                        errorMsg.innerHTML = '<i class="fas fa-exclamation-circle"></i> Por favor, ingrese el motivo del rechazo.';
                        textarea.parentNode.appendChild(errorMsg);
                    }
                    
                    return;
                }
                
                // Agregar el motivo al campo oculto
                document.getElementById('observacionesRechazo').value = motivo;
                
                // Cerrar el modal
                cerrarModal();
                
                // Enviar el formulario después de un pequeño delay
                setTimeout(function() {
                    if (formRechazoActual) {
                        formRechazoActual.submit();
                    }
                }, 300);
            });
        }
        
        // Manejar botones de cerrar modal
        const closeButtons = document.querySelectorAll('#modalRechazarSolicitud .close, #modalRechazarSolicitud [data-dismiss="modal"]');
        closeButtons.forEach(function(btn) {
            btn.addEventListener('click', cerrarModal);
        });
        
        // Cerrar modal con tecla ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('modalRechazarSolicitud');
                if (modal && modal.classList.contains('show')) {
                    cerrarModal();
                }
            }
        });
        
        // Limpiar el error cuando el usuario empiece a escribir
        const motivoInput = document.getElementById('motivoRechazoInput');
        if (motivoInput) {
            motivoInput.addEventListener('input', function() {
                this.style.borderColor = '#E5E7EB';
                this.style.boxShadow = 'none';
                const errorMsg = document.getElementById('errorMotivoRechazo');
                if (errorMsg) {
                    errorMsg.remove();
                }
            });
            
            // Agregar efecto de focus al textarea
            motivoInput.addEventListener('focus', function() {
                this.style.borderColor = '#2563EB';
                this.style.boxShadow = '0 0 0 3px rgba(37, 99, 235, 0.1)';
            });
            
            motivoInput.addEventListener('blur', function() {
                if (!this.value.trim()) {
                    this.style.borderColor = '#E5E7EB';
                    this.style.boxShadow = 'none';
                }
            });
        }

        // ===== FUNCIONES PARA ABRIR/CERRAR MODALES =====
        function abrirModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) {
                console.error('Modal no encontrado:', modalId);
                return;
            }

            console.log('Abriendo modal:', modalId);

            // Intentar con jQuery/Bootstrap primero
            if (typeof $ !== 'undefined' && $.fn.modal) {
                console.log('Usando jQuery modal');
                $('#' + modalId).modal('show');
            } 
            // Intentar con Bootstrap 5 nativo
            else if (typeof bootstrap !== 'undefined') {
                console.log('Usando Bootstrap 5');
                const bsModal = new bootstrap.Modal(modal);
                bsModal.show();
            }
            // Fallback manual
            else {
                console.log('Usando fallback manual');
                // Crear backdrop
                let backdrop = document.getElementById('modal-backdrop-custom');
                if (!backdrop) {
                    backdrop = document.createElement('div');
                    backdrop.id = 'modal-backdrop-custom';
                    backdrop.className = 'modal-backdrop fade show';
                    backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1040;';
                    document.body.appendChild(backdrop);
                }
                
                // Mostrar modal
                modal.style.display = 'block';
                modal.classList.add('show');
                modal.style.zIndex = '1050';
                document.body.classList.add('modal-open');
                
                // Agregar evento para cerrar con ESC
                document.addEventListener('keydown', function cerrarConEsc(e) {
                    if (e.key === 'Escape') {
                        cerrarModal(modalId);
                        document.removeEventListener('keydown', cerrarConEsc);
                    }
                });
            }
        }

        function cerrarModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;

            console.log('Cerrando modal:', modalId);

            // Intentar con jQuery/Bootstrap
            if (typeof $ !== 'undefined' && $.fn.modal) {
                $('#' + modalId).modal('hide');
            }
            // Intentar con Bootstrap 5
            else if (typeof bootstrap !== 'undefined') {
                const bsModal = bootstrap.Modal.getInstance(modal);
                if (bsModal) bsModal.hide();
            }
            // Fallback manual
            else {
                modal.style.display = 'none';
                modal.classList.remove('show');
                document.body.classList.remove('modal-open');
                
                const backdrop = document.getElementById('modal-backdrop-custom');
                if (backdrop) backdrop.remove();
            }
        }

        // ===== MODAL AUTORIZAR =====
        const btnMostrarModalAutorizar = document.getElementById('btnMostrarModalAutorizar');
        if (btnMostrarModalAutorizar) {
            btnMostrarModalAutorizar.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Click en botón autorizar');
                abrirModal('modalAutorizarSolicitud');
            });
        }

        const btnConfirmarAutorizar = document.getElementById('btnConfirmarAutorizar');
        if (btnConfirmarAutorizar) {
            btnConfirmarAutorizar.addEventListener('click', function() {
                console.log('Confirmando autorización...');
                cerrarModal('modalAutorizarSolicitud');
                
                // Pequeño delay para que se vea el cierre del modal
                setTimeout(function() {
                    document.getElementById('formAutorizar').submit();
                }, 200);
            });
        }

        // ===== MODAL RECHAZAR =====
        const btnMostrarModalRechazar = document.getElementById('btnMostrarModalRechazar');
        if (btnMostrarModalRechazar) {
            btnMostrarModalRechazar.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Click en botón rechazar');
                
                // Limpiar el textarea
                const textarea = document.getElementById('motivoRechazoInput');
                if (textarea) {
                    textarea.value = '';
                    textarea.style.borderColor = '#E5E7EB';
                    textarea.style.boxShadow = 'none';
                }
                
                abrirModal('modalRechazarSolicitud');
            });
        }

        // Botones de cerrar modales
        document.querySelectorAll('[data-dismiss="modal"]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                const modal = this.closest('.modal');
                if (modal) {
                    cerrarModal(modal.id);
                }
            });
        });
    });
</script>
