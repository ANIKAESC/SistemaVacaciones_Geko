@model List<ProyectoDojoGeko.Models.SolicitudViewModel>
@{
    ViewData["Title"] = "Solicitudes de Vacaciones";

    // Si hay un CodigoSistema en sesión, usar el layout del sistema
    // De lo contrario, usar el layout por defecto
    var codigoSistema = Context.Session.GetString("SistemaActual");
    Layout = (!string.IsNullOrEmpty(codigoSistema)) ?
        "~/Views/Shared/_DashboardLayoutSistema.cshtml" :
        "~/Views/Shared/_DashboardLayout.cshtml";

    var contrato = Context.Session.GetString("TipoContrato");
    var codigo = Context.Session.GetString("CodigoEmpleado");
    var nombre = Context.Session.GetString("NombreCompletoEmpleado");
    var diasDisponibles = ViewBag.DiasDisponibles;
	// Creamos una lista para seleccionar los estados de las solicitudes y mostrar los nombres en lugar de los valores
    //var estados = (List<SelectListItem>)ViewBag.Estados;
    var estados = ViewBag.Estados as List<SelectListItem> ?? new List<SelectListItem>();
    var fecha = DateTime.UtcNow;
}

<div class="solicitudes-container">
    <div class="page-header">
        <div class="header-content">
            <h1 class="page-title">
                <i class="fas fa-plane-departure"></i>
                Solicitudes de Vacaciones
            </h1>
            <p class="page-subtitle">
                Consulta y gestiona tus solicitudes de vacaciones.
            </p>
        </div>
        <div class="header-actions">
            <button type="button" class="btn-cumpleanos" data-bs-toggle="modal" data-bs-target="#modalCumpleanos">
                <i class="fas fa-birthday-cake"></i>
                Solicitud por Cumpleaños
            </button>
        </div>
    </div>

    <div class="form-card empleado-info-card">
        <div class="info-row">
            <span style="display:none;">C�digo: <strong>@(codigo ?? "-----")</strong></span>
            <span>Fecha: <strong>@fecha.ToString("dd/MM/yyyy")</strong></span>
            <span>Días disponibles: <strong>@(ViewBag.DiasDisponibles ?? "--")</strong></span>
        </div>
        <div class="info-row">
            <span>Nombre: <strong>@(nombre ?? "-----")</strong></span>
            <span>Código: <strong>@(codigo ?? "-----")</strong></span>
        </div>
    </div>

    <div class="form-card solicitudes-list-card">
        <div class="solicitudes-header">
            <h2><i class="fas fa-list"></i> Solicitudes</h2>

        </div>
        <table class="table table-striped" id="tablaSolicitudes">
            <thead>
                <tr>
                    <th>No. Solicitud</th>
                    <th>Fecha Ingreso</th>
                    <th>Días Solicitados</th>
                    <th>Estado</th>
                    <th style="text-align: center;">Acciones</th>
                </tr>
            </thead>
            <tbody>
                @if (Model != null && Model.Count > 0)
                {
                    @for (int i = 0; i < Model.Count; i++)
                    {
                        var solicitud = Model[i];
                        var nombreEstado = estados.FirstOrDefault(e => e.Value == solicitud.Encabezado.Estado.ToString())?.Text ?? "Desconocido";
                        var estadoBadgeClass = solicitud.Encabezado.Estado switch
                        {
                            1 => "badge-ingresada",      // Ingresada - Azul
                            2 => "badge-autorizada",     // Autorizada - Verde
                            3 => "badge-vigente",        // Vigente - Verde claro
                            4 => "badge-finalizada",     // Finalizada - Gris
                            5 => "badge-cancelada",      // Cancelada - Rojo
                            6 => "badge-rechazada",      // Rechazada - Rojo oscuro
                            _ => "badge-default"         // Desconocido
                        };
                        <tr class="main-row" data-toggle="collapse" data-target="#detalles-@solicitud.Encabezado.IdSolicitud" data-id="@solicitud.Encabezado.IdSolicitud" data-estado="@nombreEstado">
                            <td>@solicitud.Encabezado.IdSolicitud</td>
                            <td>@solicitud.Encabezado.FechaIngresoSolicitud.ToString("dd/MM/yyyy")</td>
                            <td>@solicitud.Encabezado.DiasSolicitadosTotal</td>
                            <td>
                                <span class="badge @estadoBadgeClass">@nombreEstado</span>
                            </td>
                            <td style="text-align: center;">
                                <a href="@Url.Action("DetallePDF", "Solicitudes", new { id = solicitud.Encabezado.IdSolicitud, soloVer = true })" 
                                   class="btn-ver-detalle" 
                                   title="Ver detalle de la solicitud">
                                    <i class="fas fa-eye"></i> Ver detalle
                                </a>
                            </td>
                        </tr>
                        <tr class="collapse-row" id="detalles-@solicitud.Encabezado.IdSolicitud" style="display:none;">
                            <td colspan="5">
                                <strong>Fechas solicitadas:</strong>
                                <ul>
                                    @foreach (var detalle in solicitud.Detalles)
                                    {
                                        <li>
                                            @detalle.FechaInicio.ToString("dd/MM/yyyy") - @detalle.FechaFin.ToString("dd/MM/yyyy") (@detalle.DiasHabilesTomados día(s))
                                        </li>
                                    }
                                </ul>
                                @* Mostrar motivo del rechazo si aplica *@
                                @if (solicitud.Encabezado.Estado == 6 && !string.IsNullOrEmpty(solicitud.Encabezado.MotivoRechazo))
                                {
                                    <div style="margin-top: 10px; padding: 10px; background: #FEE2E2; border-left: 4px solid #DC2626; border-radius: 4px;">
                                        <strong style="color: #991B1B;">
                                            <i class="fas fa-exclamation-triangle"></i> Motivo del Rechazo:
                                        </strong>
                                        <p style="margin: 5px 0 0 0; color: #7F1D1D;">@solicitud.Encabezado.MotivoRechazo</p>
                                    </div>
                                }
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="5" class="text-center">No hay solicitudes registradas.</td>
                    </tr>
                }
            </tbody>
        </table>
        <div class="actions-container">
            <button class="btn-submit" onclick="location.href='@Url.Action("Crear", "Solicitudes")'">
                <i class="fas fa-plus"></i> Agregar solicitud
            </button>

            <button class="btn-cancel"><i class="fas fa-times"></i> Cancelar solicitud</button>
            <!--<button class="btn-reset"><i class="fas fa-paper-plane"></i> Solicitar autorización</button>-->
        </div>

        <!-- Paginación -->
        <div class="pagination-container">
            <div class="pagination-info">
                Mostrando <span id="showing-start">1</span> a <span id="showing-end">@Model.Count()</span> de <span id="total-items">@Model.Count()</span> solicitudes
            </div>
            <div class="pagination-controls">
                <button id="prev-page" class="pagination-btn" disabled>
                    <i class="fas fa-chevron-left"></i>
                    Anterior
                </button>
                <div class="pagination-pages" id="pagination-pages">
                    <button class="page-btn active">1</button>
                </div>
                <button id="next-page" class="pagination-btn" disabled>
                    Siguiente
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>

</div>

<form id="cancelForm" asp-action="CancelarSolicitud" method="post" style="display: none;">
    <input type="hidden" id="idSolicitud" name="idSolicitud" />
</form>

<!-- Modal Solicitud por Cumpleaños -->
<div class="modal fade" id="modalCumpleanos" tabindex="-1" aria-labelledby="modalCumpleanosLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalCumpleanosLabel">
                    <i class="fas fa-birthday-cake"></i> Solicitud por Cumpleaños
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="formCumpleanos" asp-action="SolicitudCumpleanos" asp-controller="Solicitudes" method="get">
                <div class="modal-body">
                    <p class="text-muted mb-3">
                        <i class="fas fa-info-circle"></i> 
                        Configura tu solicitud de día de cumpleaños seleccionando el autorizador y el formato del PDF.
                    </p>

                    <!-- Selector de Autorizador -->
                    <div class="mb-3">
                        <label for="idAutorizador" class="form-label">
                            <i class="fas fa-user-tie icon-label"></i>Autorizador <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="idAutorizador" name="idAutorizador" required>
                            <option value="">Seleccione un autorizador...</option>
                            @if (ViewBag.empleadosAutoriza != null)
                            {
                                @foreach (var empleado in ViewBag.empleadosAutoriza as List<SelectListItem>)
                                {
                                    <option value="@empleado.Value">@empleado.Text</option>
                                }
                            }
                        </select>
                    </div>

                    <!-- Selector de Formato PDF -->
                    <div class="mb-3">
                        <label for="tipoFormato" class="form-label">
                            <i class="fas fa-file-pdf icon-label"></i>Formato de PDF <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="tipoFormato" name="tipoFormato" required>
                            <option value="">Seleccione un formato...</option>
                            <option value="1">Formato GDG</option>
                            <option value="2">Formato GEKO</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check"></i> Confirmar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/empleado-form.css" />
    <style>
        :root {
            --primary-color: #003C9D;
            --secondary-color: #6c757d;
            --highlight-color: #F39C12;
            --light-bg: #f8f9fa;
            --soft-gray: #e9ecef;
            --text-color: #343a40;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .solicitudes-container {
            padding: 30px;
            background-color: #fdfdfd;
        }

        .page-header {
            margin-bottom: 25px;
            border-bottom: 2px solid var(--soft-gray);
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-content {
            flex: 1;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        .btn-cumpleanos {
            background: linear-gradient(135deg, #8ab5ff, #4F81D6);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-weight: 350;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgb(138, 181, 255);
        }

        .btn-cumpleanos:hover {
            transform: translateY(-2px);
                box-shadow: 0 6px 16px rgb(138, 181, 255);
                background: linear-gradient(135deg, #4F81D6, #8ab5ff);
        }

        .btn-cumpleanos i {
            font-size: 16px;
        }

        .page-title {
            font-size: 28px;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .page-subtitle {
            font-size: 15px;
            color: #6c757d;
        }

        .form-card {
            background: white;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }

        .empleado-info-card .info-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 15px;
            color: var(--text-color);
        }

        .solicitudes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

            .solicitudes-header h2 {
                font-size: 22px;
                color: var(--primary-color);
            }

        .table {
            width: 100%;
            font-size: 15px;
            border-collapse: separate;
            border-spacing: 0 12px;
        }

            .table th {
                background-color: var(--primary-color);
                color: white;
                padding: 12px;
                text-align: center;
                border-radius: 12px 12px 0 0;
            }

            .table td {
                background-color: #ffffff;
                border: 1px solid #dee2e6;
                vertical-align: middle;
                text-align: center;
                border-radius: 0;
                padding: 10px;
            }

            .table tr.main-row {
                box-shadow: 0 2px 6px rgba(0,0,0,0.06);
                transition: all 0.3s ease-in-out;
                cursor: pointer;
            }

                .table tr.main-row:hover {
                    background-color: #f1f3f5;
                    transform: scale(1.005);
                }

        .badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            display: inline-block;
        }

        .badge-success {
            background-color: #28a745;
            color: white;
        }

        .badge-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .badge-info {
            background-color: #0dcaf0;
            color: white;
        }

        .actions-container {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 25px;
        }

        .btn-submit,
        .btn-cancel,
        .btn-reset {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            font-size: 15px;
            transition: background-color 0.3s ease;
        }

        .btn-submit {
            background-color: var(--primary-color);
        }

            .btn-submit:hover {
                background-color: #002f7d;
            }

        .btn-cancel {
            background-color: var(--secondary-color);
        }

            .btn-cancel:hover {
                background-color: #5a6268;
            }

        .btn-reset {
            background-color: var(--highlight-color);
        }

            .btn-reset:hover {
                background-color: #d48806;
            }

            .btn-submit i,
            .btn-cancel i,
            .btn-reset i {
                margin-right: 6px;
            }

        .table tr.selected-row td {
            background-color: #d6eaff; /* Light blue for selection */
        }

        /* Badges de estados con colores específicos */
        .badge {
            display: inline-block;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 600;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-ingresada {
            background: linear-gradient(135deg, #3B82F6, #2563EB);
            color: white;
        }

        .badge-autorizada {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
        }

        .badge-vigente {
            background: linear-gradient(135deg, #22C55E, #16A34A);
            color: white;
        }

        .badge-finalizada {
            background: linear-gradient(135deg, #6B7280, #4B5563);
            color: white;
        }

        .badge-cancelada {
            background: linear-gradient(135deg, #F59E0B, #D97706);
            color: white;
        }

        .badge-rechazada {
            background: linear-gradient(135deg, #EF4444, #DC2626);
            color: white;
        }

        .badge-default {
            background: linear-gradient(135deg, #9CA3AF, #6B7280);
            color: white;
        }

        /* Botón Ver detalle mejorado */
        .btn-ver-detalle {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #003C9D, #002a6e);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 60, 157, 0.2);
        }

        .btn-ver-detalle:hover {
            background: linear-gradient(135deg, #002a6e, #001a4d);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 60, 157, 0.3);
            color: white;
            text-decoration: none;
        }

        .btn-ver-detalle i {
            font-size: 14px;
        }

        /* Paginación */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
        }

        .pagination-info {
            font-size: 14px;
            color: var(--gray-600);
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pagination-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--white);
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius-sm);
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-700);
            cursor: pointer;
            transition: var(--transition);
        }

            .pagination-btn:hover:not(:disabled) {
                background: var(--gray-100);
                color: var(--gray-800);
            }

            .pagination-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

        .pagination-pages {
            display: flex;
            gap: 4px;
        }

        .page-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--border-radius-sm);
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-700);
            background: var(--white);
            border: 1px solid var(--gray-300);
            cursor: pointer;
            transition: var(--transition);
        }

            .page-btn:hover:not(.active) {
                background: var(--gray-100);
                color: var(--gray-800);
            }

            .page-btn.active {
                background: var(--primary-color);
                color: var(--white);
                border-color: var(--primary-color);
            }


        /* Responsive */
        @@media (max-width: 768px) {
            .empleado-info-card .info-row
            {
                flex-direction: column;
                gap: 6px;
            }

            .actions-container {
                flex-direction: column;
                align-items: stretch;
            }

        }

        /* ===== ESTILOS PARA MODAL CUMPLEAÑOS ===== */
        #modalCumpleanos {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            z-index: 9999 !important;
            display: none;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #modalCumpleanos.show {
            display: block !important;
        }

        #modalCumpleanos .modal-dialog {
            position: relative;
            width: auto;
            max-width: 600px; /* Modal más pequeño */
            margin: 1.75rem auto;
            pointer-events: none;
        }

        #modalCumpleanos .modal-content {
            position: relative;
            display: flex;
            flex-direction: column;
            width: 100%;
            text-align: left;
            pointer-events: auto;
            background-color: #fff;
            background-clip: padding-box;
            border: 1px solid rgba(0,0,0,.2);
            border-radius: 0.5rem;
            outline: 0;
        }

        .modal-backdrop {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            z-index: 9998 !important;
            width: 100vw;
            height: 100vh;
            background-color: #000;
        }

        .modal-backdrop.show {
            opacity: 0.5;
        }

        /* ===== ESTILOS INTERNOS DEL MODAL ===== */
        #modalCumpleanos .modal-header {
            background: linear-gradient(135deg, #4F81D6, #7C9CD6);
            color: white;
            border-bottom: none;
            border-radius: 0.5rem 0.5rem 0 0;
            padding: 1.5rem;
        }

        #modalCumpleanos .modal-title {
            font-weight: 600;
            font-size: 1.25rem;
            display: flex;
            align-items: left;
            gap: 0.5rem;
        }

        #modalCumpleanos .modal-title i {
            font-size: 1.5rem;
        }

        #modalCumpleanos .btn-close {
            filter: brightness(0) invert(1);
            opacity: 0.8;
        }

        #modalCumpleanos .btn-close:hover {
            opacity: 1;
        }

        #modalCumpleanos .modal-body {
            padding: 1.5rem;
            background: #f8f9fa;
        }

        #modalCumpleanos .modal-body p.text-muted {
            background: white;
            padding: 0.75rem;
            border-radius: 0.5rem;
                border-left: 4px solid #4F81D6;
            margin-bottom: 1.25rem;
            font-size: 0.9rem;
        }

        #modalCumpleanos .form-label {
            font-weight: 600;
            color: #343a40;
            margin-bottom: 0.5rem;
            display: block;
            text-align: left;
        }

        #modalCumpleanos .form-label i.icon-label {
                color: #4F81D6;
            display: inline-block;
            width: 20px; /* Ancho fijo para alineación perfecta */
            text-align: center;
            margin-right: 0.5rem;
        }

        #modalCumpleanos .form-select {
            border: 2px solid #e9ecef;
            border-radius: 0.5rem;
            padding: 0.75rem;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            width: 100%; /* Asegurar que ambos selectores tengan el mismo ancho */
        }

        #modalCumpleanos .form-select:focus {
                border-color: #4F81D6;
                box-shadow: 0 0 0 0.2rem rgba(79, 129, 214, 0.3);
        }

        #modalCumpleanos .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid #dee2e6;
            background: white;
            border-radius: 0 0 0.5rem 0.5rem;
        }

        #modalCumpleanos .btn-secondary {
            background: #6c757d;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        #modalCumpleanos .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        #modalCumpleanos .btn-primary {
            background: linear-gradient(135deg, #7C9CD6, #4F81D6);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgb(138, 181, 255);
        }

        #modalCumpleanos .btn-primary:hover {
                background: linear-gradient(135deg, #4F81D6, #7C9CD6);
            transform: translateY(-2px);
                box-shadow: 0 6px 16px rgb(138, 181, 255);
        }
    </style>
}


@section Scripts {
    <script>
        // Inicializar modal de cumpleaños
        document.addEventListener('DOMContentLoaded', function() {
            const modalCumpleanos = document.getElementById('modalCumpleanos');
            const btnCumpleanos = document.querySelector('[data-bs-target="#modalCumpleanos"]');
            
            if (btnCumpleanos && modalCumpleanos) {
                btnCumpleanos.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Crear backdrop
                    const backdrop = document.createElement('div');
                    backdrop.className = 'modal-backdrop fade show';
                    backdrop.id = 'modalBackdrop';
                    document.body.appendChild(backdrop);
                    
                    // Mostrar modal
                    modalCumpleanos.classList.add('show');
                    modalCumpleanos.style.display = 'block';
                    document.body.classList.add('modal-open');
                    
                    // Cerrar modal
                    const closeButtons = modalCumpleanos.querySelectorAll('[data-bs-dismiss="modal"]');
                    closeButtons.forEach(btn => {
                        btn.addEventListener('click', function() {
                            modalCumpleanos.classList.remove('show');
                            modalCumpleanos.style.display = 'none';
                            document.body.classList.remove('modal-open');
                            const existingBackdrop = document.getElementById('modalBackdrop');
                            if (existingBackdrop) {
                                existingBackdrop.remove();
                            }
                        });
                    });
                    
                    // Cerrar al hacer click en el backdrop
                    backdrop.addEventListener('click', function() {
                        modalCumpleanos.classList.remove('show');
                        modalCumpleanos.style.display = 'none';
                        document.body.classList.remove('modal-open');
                        backdrop.remove();
                    });
                });
            }

            // Validar formulario de cumpleaños antes de enviar
            const formCumpleanos = document.getElementById('formCumpleanos');
            if (formCumpleanos) {
                formCumpleanos.addEventListener('submit', function(e) {
                    const idAutorizador = document.getElementById('idAutorizador').value;
                    const tipoFormato = document.getElementById('tipoFormato').value;

                    if (!idAutorizador || idAutorizador === '') {
                        e.preventDefault();
                        alert('Por favor, selecciona un autorizador.');
                        return false;
                    }

                    if (!tipoFormato || tipoFormato === '') {
                        e.preventDefault();
                        alert('Por favor, selecciona un formato de PDF.');
                        return false;
                    }

                    // Si todo está bien, mostrar loading
                    console.log('✅ Formulario válido, enviando...');
                    console.log('IdAutorizador:', idAutorizador);
                    console.log('TipoFormato:', tipoFormato);
                });
            }
        });

        let selectedRow = null;
        let selectedSolicitudId = 0;
        let selectedEstado = '';

        document.querySelectorAll('.main-row').forEach(row => {
            row.addEventListener('click', function (e) {
                // Evita que el evento se propague si haces click en un botón dentro de la fila
                if (e.target.tagName === 'BUTTON' || e.target.closest('button')) return;

                // Handle row selection
                if (selectedRow) {
                    selectedRow.classList.remove('selected-row');
                }
                selectedRow = this;
                selectedRow.classList.add('selected-row');

                selectedSolicitudId = selectedRow.dataset.id;
                selectedEstado = selectedRow.dataset.estado;

                const targetId = this.getAttribute('data-target');
                const detalleRow = document.querySelector(targetId);
                const icon = this.querySelector('.fa-chevron-down, .fa-chevron-up');
                if (detalleRow.style.display === "none" || !detalleRow.style.display) {
                    detalleRow.style.display = "table-row";
                    if (icon) {
                        icon.classList.remove('fa-chevron-down');
                        icon.classList.add('fa-chevron-up');
                    }
                } else {
                    detalleRow.style.display = "none";
                    if (icon) {
                        icon.classList.remove('fa-chevron-up');
                        icon.classList.add('fa-chevron-down');
                    }
                }
            });
        });

        document.querySelector('.btn-cancel').addEventListener('click', function () {
            if (!selectedRow) {
                alert('Por favor, seleccione una solicitud para cancelar.');
                return;
            }

            if (selectedEstado !== 'Ingresada') {
                alert('Solo se pueden cancelar solicitudes en estado "Ingresada".');
                return;
            }

            if (confirm('¿Está seguro de que desea cancelar la solicitud seleccionada?')) {
                document.getElementById('idSolicitud').value = selectedSolicitudId;
                document.getElementById('cancelForm').submit();
            }
        });

        // Inicializar paginación
        initPagination();

        function initPagination() {
            const table = document.getElementById('tablaSolicitudes');
            if (!table) return;

            const rowsPerPage = 10;
            const mainRows = Array.from(table.querySelectorAll('tbody tr.main-row'));
            const totalRows = mainRows.length;
            const totalPages = Math.ceil(totalRows / rowsPerPage);

            // Si no hay suficientes filas, ocultar paginación
            if (totalPages <= 1) {
                document.querySelector('.pagination-container').style.display = 'none';
                return;
            }

            let currentPage = 1;

            // Función para mostrar página
            function showPage(pageNumber) {
                currentPage = pageNumber;
                const startIndex = (pageNumber - 1) * rowsPerPage;
                const endIndex = Math.min(startIndex + rowsPerPage, totalRows);

                // Cerrar todas las filas de detalles al cambiar de página
                document.querySelectorAll('.collapse-row').forEach(detailRow => {
                    detailRow.style.display = 'none';
                    // Resetear iconos
                    const mainRow = detailRow.previousElementSibling;
                    if (mainRow) {
                        const icon = mainRow.querySelector('.fa-chevron-up');
                        if (icon) {
                            icon.classList.remove('fa-chevron-up');
                            icon.classList.add('fa-chevron-down');
                        }
                    }
                });

                // Mostrar/ocultar filas principales
                mainRows.forEach((row, index) => {
                    row.style.display = (index >= startIndex && index < endIndex) ? '' : 'none';
                });

                // Actualizar info de paginación
                document.getElementById('showing-start').textContent = totalRows > 0 ? startIndex + 1 : 0;
                document.getElementById('showing-end').textContent = endIndex;
                document.getElementById('total-items').textContent = totalRows;

                // Actualizar botones
                document.getElementById('prev-page').disabled = pageNumber === 1;
                document.getElementById('next-page').disabled = pageNumber === totalPages;

                // Actualizar botones de página
                updatePageButtons();
            }

            // Función para crear botones de página
            function updatePageButtons() {
                const paginationPages = document.getElementById('pagination-pages');
                paginationPages.innerHTML = '';

                const maxVisiblePages = 5;
                let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
                let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

                if (endPage - startPage < maxVisiblePages - 1) {
                    startPage = Math.max(1, endPage - maxVisiblePages + 1);
                }

                // Botón primera página
                if (startPage > 1) {
                    const firstBtn = createPageButton(1);
                    paginationPages.appendChild(firstBtn);
                    if (startPage > 2) {
                        const dots = document.createElement('span');
                        dots.textContent = '...';
                        dots.style.padding = '0 8px';
                        dots.style.color = 'var(--gray-500)';
                        paginationPages.appendChild(dots);
                    }
                }

                // Botones de páginas
                for (let i = startPage; i <= endPage; i++) {
                    const btn = createPageButton(i);
                    paginationPages.appendChild(btn);
                }

                // Botón última página
                if (endPage < totalPages) {
                    if (endPage < totalPages - 1) {
                        const dots = document.createElement('span');
                        dots.textContent = '...';
                        dots.style.padding = '0 8px';
                        dots.style.color = 'var(--gray-500)';
                        paginationPages.appendChild(dots);
                    }
                    const lastBtn = createPageButton(totalPages);
                    paginationPages.appendChild(lastBtn);
                }
            }

            // Crear botón de página
            function createPageButton(pageNumber) {
                const btn = document.createElement('button');
                btn.className = 'page-btn' + (pageNumber === currentPage ? ' active' : '');
                btn.textContent = pageNumber;
                btn.onclick = () => showPage(pageNumber);
                return btn;
            }

            // Event listeners para botones anterior/siguiente
            document.getElementById('prev-page').addEventListener('click', function() {
                if (currentPage > 1) {
                    showPage(currentPage - 1);
                }
            });

            document.getElementById('next-page').addEventListener('click', function() {
                if (currentPage < totalPages) {
                    showPage(currentPage + 1);
                }
            });

            // Mostrar primera página
            showPage(1);
        }

        // Mostrar mensajes de éxito o error con SweetAlert2
        @if (TempData["Success"] != null)
        {
            <text>
            Swal.fire({
                icon: 'success',
                title: '¡Éxito!',
                text: '@TempData["Success"]',
                confirmButtonText: 'Aceptar',
                confirmButtonColor: '#10B981',
                timer: 5000,
                timerProgressBar: true
            });
            </text>
        }

        @if (TempData["Error"] != null)
        {
            <text>
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: '@TempData["Error"]',
                confirmButtonText: 'Aceptar',
                confirmButtonColor: '#EF4444'
            });
            </text>
        }
    </script>
}