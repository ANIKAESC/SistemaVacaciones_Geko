@model List<ProyectoDojoGeko.Models.SolicitudViewModel>
@{
    ViewData["Title"] = "Solicitudes de Vacaciones";

    // Si hay un CodigoSistema en sesión, usar el layout del sistema
    // De lo contrario, usar el layout por defecto
    var codigoSistema = Context.Session.GetString("SistemaActual");
    Layout = (!string.IsNullOrEmpty(codigoSistema)) ?
        "~/Views/Shared/_DashboardLayoutSistema.cshtml" :
        "~/Views/Shared/_DashboardLayout.cshtml";

    var contrato = Context.Session.GetString("TipoContrato");
    var codigo = Context.Session.GetString("CodigoEmpleado");
    var nombre = Context.Session.GetString("NombreCompletoEmpleado");
    var diasDisponibles = ViewBag.DiasDisponibles;
	// Creamos una lista para seleccionar los estados de las solicitudes y mostrar los nombres en lugar de los valores
    //var estados = (List<SelectListItem>)ViewBag.Estados;
    var estados = ViewBag.Estados as List<SelectListItem> ?? new List<SelectListItem>();
    var fecha = DateTime.UtcNow;
}

<div class="solicitudes-container">
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger" role="alert">@TempData["Error"]</div>
    }
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success" role="alert">@TempData["Success"]</div>
    }
    <div class="page-header">
        <div class="header-content">
            <h1 class="page-title">
                <i class="fas fa-plane-departure"></i>
                Solicitudes de Vacaciones
            </h1>
            <p class="page-subtitle">
                Consulta y gestiona tus solicitudes de vacaciones.
            </p>
        </div>
    </div>

    <div class="form-card empleado-info-card">
        <div class="info-row">
            <span style="display:none;">C�digo: <strong>@(codigo ?? "-----")</strong></span>
            <span>Fecha: <strong>@fecha.ToString("dd/MM/yyyy")</strong></span>
            <span>Días disponibles: <strong>@(ViewBag.DiasDisponibles ?? "--")</strong></span>
        </div>
        <div class="info-row">
            <span>Nombre: <strong>@(nombre ?? "-----")</strong></span>
            <span>Código: <strong>@(codigo ?? "-----")</strong></span>
        </div>
    </div>

    <div class="form-card solicitudes-list-card">
        <div class="solicitudes-header">
            <h2><i class="fas fa-list"></i> Solicitudes</h2>

        </div>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>No. Solicitud</th>
                    <th>Fecha Ingreso</th>
                    <th>Días Solicitados</th>
                    <th>Estado</th>
                    <th style="text-align: center;">Acciones</th>
                </tr>
            </thead>
            <tbody>
                @if (Model != null && Model.Count > 0)
                {
                    @for (int i = 0; i < Model.Count; i++)
                    {
                        var solicitud = Model[i];
                        var nombreEstado = estados.FirstOrDefault(e => e.Value == solicitud.Encabezado.Estado.ToString())?.Text ?? "Desconocido";
                        var estadoBadgeClass = solicitud.Encabezado.Estado switch
                        {
                            1 => "badge-ingresada",      // Ingresada - Azul
                            2 => "badge-autorizada",     // Autorizada - Verde
                            3 => "badge-vigente",        // Vigente - Verde claro
                            4 => "badge-finalizada",     // Finalizada - Gris
                            5 => "badge-cancelada",      // Cancelada - Rojo
                            6 => "badge-rechazada",      // Rechazada - Rojo oscuro
                            _ => "badge-default"         // Desconocido
                        };
                        <tr class="main-row" data-toggle="collapse" data-target="#detalles-@solicitud.Encabezado.IdSolicitud" data-id="@solicitud.Encabezado.IdSolicitud" data-estado="@nombreEstado">
                            <td>@solicitud.Encabezado.IdSolicitud</td>
                            <td>@solicitud.Encabezado.FechaIngresoSolicitud.ToString("dd/MM/yyyy")</td>
                            <td>@solicitud.Encabezado.DiasSolicitadosTotal</td>
                            <td>
                                <span class="badge @estadoBadgeClass">@nombreEstado</span>
                            </td>
                            <td style="text-align: center;">
                                <a href="@Url.Action("DetallePDF", "Solicitudes", new { id = solicitud.Encabezado.IdSolicitud, soloVer = true })" 
                                   class="btn-ver-detalle" 
                                   title="Ver detalle de la solicitud">
                                    <i class="fas fa-eye"></i> Ver detalle
                                </a>
                            </td>
                        </tr>
                        <tr class="collapse-row" id="detalles-@solicitud.Encabezado.IdSolicitud" style="display:none;">
                            <td colspan="5">
                                <strong>Fechas solicitadas:</strong>
                                <ul>
                                    @foreach (var detalle in solicitud.Detalles)
                                    {
                                        <li>
                                            @detalle.FechaInicio.ToString("dd/MM/yyyy") - @detalle.FechaFin.ToString("dd/MM/yyyy") (@detalle.DiasHabilesTomados día(s))
                                        </li>
                                    }
                                </ul>
                                @* Mostrar motivo del rechazo si aplica *@
                                @if (solicitud.Encabezado.Estado == 6 && !string.IsNullOrEmpty(solicitud.Encabezado.MotivoRechazo))
                                {
                                    <div style="margin-top: 10px; padding: 10px; background: #FEE2E2; border-left: 4px solid #DC2626; border-radius: 4px;">
                                        <strong style="color: #991B1B;">
                                            <i class="fas fa-exclamation-triangle"></i> Motivo del Rechazo:
                                        </strong>
                                        <p style="margin: 5px 0 0 0; color: #7F1D1D;">@solicitud.Encabezado.MotivoRechazo</p>
                                    </div>
                                }
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="5" class="text-center">No hay solicitudes registradas.</td>
                    </tr>
                }
            </tbody>
        </table>
        <div class="actions-container">
            <button class="btn-submit" onclick="location.href='@Url.Action("Crear", "Solicitudes")'">
                <i class="fas fa-plus"></i> Agregar solicitud
            </button>

            <button class="btn-cancel"><i class="fas fa-times"></i> Cancelar solicitud</button>
            <!--<button class="btn-reset"><i class="fas fa-paper-plane"></i> Solicitar autorización</button>-->
        </div>

        <!-- Paginación -->
        <div class="pagination-container">
            <div class="pagination-info">
                Mostrando <span id="showing-start">1</span> a <span id="showing-end">@Model.Count()</span> de <span id="total-items">@Model.Count()</span> sistemas
            </div>
            <div class="pagination-controls">
                <button id="prev-page" class="pagination-btn" disabled>
                    <i class="fas fa-chevron-left"></i>
                    Anterior
                </button>
                <div class="pagination-pages" id="pagination-pages">
                    <button class="page-btn active">1</button>
                </div>
                <button id="next-page" class="pagination-btn" disabled>
                    Siguiente
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>

</div>

<form id="cancelForm" asp-action="CancelarSolicitud" method="post" style="display: none;">
    <input type="hidden" id="idSolicitud" name="idSolicitud" />
</form>

@section Styles {
    <link rel="stylesheet" href="~/css/empleado-form.css" />
    <style>
        :root {
            --primary-color: #003C9D;
            --secondary-color: #6c757d;
            --highlight-color: #F39C12;
            --light-bg: #f8f9fa;
            --soft-gray: #e9ecef;
            --text-color: #343a40;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .solicitudes-container {
            padding: 30px;
            background-color: #fdfdfd;
        }

        .page-header {
            margin-bottom: 25px;
            border-bottom: 2px solid var(--soft-gray);
            padding-bottom: 10px;
        }

        .page-title {
            font-size: 28px;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .page-subtitle {
            font-size: 15px;
            color: #6c757d;
        }

        .form-card {
            background: white;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }

        .empleado-info-card .info-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 15px;
            color: var(--text-color);
        }

        .solicitudes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

            .solicitudes-header h2 {
                font-size: 22px;
                color: var(--primary-color);
            }

        .table {
            width: 100%;
            font-size: 15px;
            border-collapse: separate;
            border-spacing: 0 12px;
        }

            .table th {
                background-color: var(--primary-color);
                color: white;
                padding: 12px;
                text-align: center;
                border-radius: 12px 12px 0 0;
            }

            .table td {
                background-color: #ffffff;
                border: 1px solid #dee2e6;
                vertical-align: middle;
                text-align: center;
                border-radius: 0;
                padding: 10px;
            }

            .table tr.main-row {
                box-shadow: 0 2px 6px rgba(0,0,0,0.06);
                transition: all 0.3s ease-in-out;
                cursor: pointer;
            }

                .table tr.main-row:hover {
                    background-color: #f1f3f5;
                    transform: scale(1.005);
                }

        .badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            display: inline-block;
        }

        .badge-success {
            background-color: #28a745;
            color: white;
        }

        .badge-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .badge-info {
            background-color: #0dcaf0;
            color: white;
        }

        .actions-container {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 25px;
        }

        .btn-submit,
        .btn-cancel,
        .btn-reset {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            font-size: 15px;
            transition: background-color 0.3s ease;
        }

        .btn-submit {
            background-color: var(--primary-color);
        }

            .btn-submit:hover {
                background-color: #002f7d;
            }

        .btn-cancel {
            background-color: var(--secondary-color);
        }

            .btn-cancel:hover {
                background-color: #5a6268;
            }

        .btn-reset {
            background-color: var(--highlight-color);
        }

            .btn-reset:hover {
                background-color: #d48806;
            }

            .btn-submit i,
            .btn-cancel i,
            .btn-reset i {
                margin-right: 6px;
            }

        .table tr.selected-row td {
            background-color: #d6eaff; /* Light blue for selection */
        }

        /* Badges de estados con colores específicos */
        .badge {
            display: inline-block;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 600;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-ingresada {
            background: linear-gradient(135deg, #3B82F6, #2563EB);
            color: white;
        }

        .badge-autorizada {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
        }

        .badge-vigente {
            background: linear-gradient(135deg, #22C55E, #16A34A);
            color: white;
        }

        .badge-finalizada {
            background: linear-gradient(135deg, #6B7280, #4B5563);
            color: white;
        }

        .badge-cancelada {
            background: linear-gradient(135deg, #F59E0B, #D97706);
            color: white;
        }

        .badge-rechazada {
            background: linear-gradient(135deg, #EF4444, #DC2626);
            color: white;
        }

        .badge-default {
            background: linear-gradient(135deg, #9CA3AF, #6B7280);
            color: white;
        }

        /* Botón Ver detalle mejorado */
        .btn-ver-detalle {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #003C9D, #002a6e);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 60, 157, 0.2);
        }

        .btn-ver-detalle:hover {
            background: linear-gradient(135deg, #002a6e, #001a4d);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 60, 157, 0.3);
            color: white;
            text-decoration: none;
        }

        .btn-ver-detalle i {
            font-size: 14px;
        }

        /* Paginación */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
        }

        .pagination-info {
            font-size: 14px;
            color: var(--gray-600);
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pagination-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--white);
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius-sm);
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-700);
            cursor: pointer;
            transition: var(--transition);
        }

            .pagination-btn:hover:not(:disabled) {
                background: var(--gray-100);
                color: var(--gray-800);
            }

            .pagination-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

        .pagination-pages {
            display: flex;
            gap: 4px;
        }

        .page-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--border-radius-sm);
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-700);
            background: var(--white);
            border: 1px solid var(--gray-300);
            cursor: pointer;
            transition: var(--transition);
        }

            .page-btn:hover:not(.active) {
                background: var(--gray-100);
                color: var(--gray-800);
            }

            .page-btn.active {
                background: var(--primary-color);
                color: var(--white);
                border-color: var(--primary-color);
            }


        /* Responsive */
        @@media (max-width: 768px) {
            .empleado-info-card .info-row
            {
                flex-direction: column;
                gap: 6px;
            }

            .actions-container {
                flex-direction: column;
                align-items: stretch;
            }

        }
    </style>
}


@section Scripts {
    <script>
        let selectedRow = null;
        let selectedSolicitudId = 0;
        let selectedEstado = '';

        document.querySelectorAll('.main-row').forEach(row => {
            row.addEventListener('click', function (e) {
                // Evita que el evento se propague si haces click en un botón dentro de la fila
                if (e.target.tagName === 'BUTTON' || e.target.closest('button')) return;

                // Handle row selection
                if (selectedRow) {
                    selectedRow.classList.remove('selected-row');
                }
                selectedRow = this;
                selectedRow.classList.add('selected-row');

                selectedSolicitudId = selectedRow.dataset.id;
                selectedEstado = selectedRow.dataset.estado;

                const targetId = this.getAttribute('data-target');
                const detalleRow = document.querySelector(targetId);
                const icon = this.querySelector('.fa-chevron-down, .fa-chevron-up');
                if (detalleRow.style.display === "none" || !detalleRow.style.display) {
                    detalleRow.style.display = "table-row";
                    if (icon) {
                        icon.classList.remove('fa-chevron-down');
                        icon.classList.add('fa-chevron-up');
                    }
                } else {
                    detalleRow.style.display = "none";
                    if (icon) {
                        icon.classList.remove('fa-chevron-up');
                        icon.classList.add('fa-chevron-down');
                    }
                }
            });
        });

        document.querySelector('.btn-cancel').addEventListener('click', function () {
            if (!selectedRow) {
                alert('Por favor, seleccione una solicitud para cancelar.');
                return;
            }

            if (selectedEstado !== 'Ingresada') {
                alert('Solo se pueden cancelar solicitudes en estado "Ingresada".');
                return;
            }

            if (confirm('¿Está seguro de que desea cancelar la solicitud seleccionada?')) {
                document.getElementById('idSolicitud').value = selectedSolicitudId;
                document.getElementById('cancelForm').submit();
            }
        });
    </script>
}