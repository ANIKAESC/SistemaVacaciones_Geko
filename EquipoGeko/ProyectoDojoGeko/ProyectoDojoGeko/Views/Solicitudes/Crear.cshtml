@model ProyectoDojoGeko.Models.SolicitudViewModel
@{
    ViewData["Title"] = "Gesti√≥n de Solicitudes Vacacionales - GEKO Sistemas";
    
    // Si hay un CodigoSistema en sesi√≥n, usar el layout del sistema
    // De lo contrario, usar el layout por defecto
    var codigoSistema = Context.Session.GetString("SistemaActual");
    Layout = (!string.IsNullOrEmpty(codigoSistema)) ?
        "~/Views/Shared/_DashboardLayoutSistema.cshtml" :
        "~/Views/Shared/_DashboardLayout.cshtml";

    var contrato = Context.Session.GetString("TipoContrato");
    var codigo = Context.Session.GetString("CodigoEmpleado");
    var nombre = Context.Session.GetString("NombreCompletoEmpleado");
    var diasDisponibles = ViewBag.DiasDisponibles;
    var fecha = DateTime.Now;

    // Obtener listas de autorizadores
    var empleadosAutorizaEquipo = ViewBag.EmpleadosAutorizaEquipo as List<SelectListItem> ?? new List<SelectListItem>();
    var empleadosAutoriza = ViewBag.empleadosAutoriza as List<SelectListItem> ?? new List<SelectListItem>();
}

<div class="solicitudes-container">
    <div class="page-header">
        <h2 class="page-title">Gesti√≥n de Solicitudes de d√≠as de disponibilidad</h2>
        <p class="page-subtitle">Solicita tus d√≠as disponibles con facilidad</p>
    </div>

    <div class="form-card">
        <div class="empleado-info-card" style="margin-bottom: 20px;">
            <div class="info-row">
                <span style="display:none;">C√≥digo: <strong>@(codigo ?? "-----")</strong></span>
                <span>Fecha: <strong>@fecha.ToString("dd/MM/yyyy")</strong></span>
                <span>D√≠as disponibles: <strong>@(ViewBag.DiasDisponibles ?? "--")</strong></span>
            </div>
            <div class="info-row">
                <span>Nombre: <strong>@(nombre ?? "-----")</strong></span>
                <span>C√≥digo: <strong>@(codigo ?? "-----")</strong></span>
            </div>
        </div>

        <form asp-action="Crear" asp-controller="Solicitudes" method="post" id="solicitudForm" enctype="multipart/form-data" novalidate>
            @Html.AntiForgeryToken()
            <div class="form-group">
                <label class="form-label">Fechas a solicitar <span style="color: #c00;">*</span></label>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <input type="date" id="NuevaFechaInicio" class="form-control" style="flex:1;" />
                    <input type="date" id="NuevaFechaFin" class="form-control" style="flex:1;" />
                </div>
                <div style="margin-top: 20px; display: flex; justify-content: center;">
                    <button type="button" class="btn-agregar" onclick="agregarRango()">
                        <i class="fas fa-plus"></i> Agregar rango de fechas
                    </button>
                </div>

            </div>

            <div class="table-container">
                <table class="table" id="tablaFechas">
                    <thead class="text-center">
                        <tr>
                            <th style="width: 25%;">Inicio</th>
                            <th style="width: 25%;">Fin</th>
                            <th style="width: 15%;">D√≠as</th>
                            <th style="width: 15%;">Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody class="text-center align-middle"></tbody>
                </table>
            </div>

            <!-- Aqu√≠ se generan los inputs ocultos para los detalles -->
            <div id="detallesContainer"></div>


            <!-- Info adicional -->
            <div class="form-group" style="margin-top: 20px;">
                <label class="form-label" style="font-size:25px;">Informaci√≥n de solicitud <span style="color: #c00;">*</span></label>

                <!-- Selector de "Autorizador" -->
                <div class="form-field" style="margin-top: 20px;">
                    <label for="Autorizador" class="form-label">
                        Seleccionar autorizador <span style="color: #c00;">*</span>
                    </label>
                    <select asp-for="Encabezado.IdAutorizador" id="Autorizador" class="form-control" required>
                        <option value="">Seleccione un autorizador</option>

                        @if (empleadosAutorizaEquipo?.Any() == true)
                        {
                            foreach (var autoriza in empleadosAutorizaEquipo)
                            {
                                <option value="@autoriza.Value">@autoriza.Text</option>
                            }
                        }
                        else if (empleadosAutoriza?.Any() == true)
                        {
                            foreach (var autoriza in empleadosAutoriza)
                            {
                                <option value="@autoriza.Value">@autoriza.Text</option>
                            }
                        }
                        else
                        {
                            <option value="">No hay empleados disponibles para autorizar</option>
                        }

                    </select>
                </div>


                <div class="form-row">
                    <div class="form-field">
                        <label for="SolicitadoLider" class="form-label">
                            ¬øYa solicitaste estos d√≠as a tu l√≠der?
                        </label>
                        <select asp-for="Encabezado.SolicitudLider" id="SolicitadoLider"
                                class="form-control" required>
                            <option value="">Seleccione una opci√≥n</option>
                            <option value="S√≠">S√≠</option>
                            <option value="No">No</option>
                        </select>
                    </div>

                    <div class="form-field">
                        <label for="TotalDias" class="form-label">
                            Total de d√≠as a tomar
                        </label>
                        <input type="number" asp-for="Encabezado.DiasSolicitadosTotal" id="TotalDias"
                               class="form-control" readonly required placeholder="0" step="0.01" />
                    </div>
                </div>
            </div>

            <!-- Observaciones -->
            <div class="form-group" style="margin-top: 20px;">
                <label for="Observaciones" class="form-label">
                    Observaciones adicionales <span class="optional-badge">(Opcional)</span>
                </label>
                <textarea asp-for="Encabezado.Observaciones" id="Observaciones"
                          class="form-control" rows="5"
                          style="width: 100%; resize: none; overflow-y: auto;"
                          placeholder="Ejemplo: Necesito estos d√≠as por motivos familiares..."></textarea>
            </div>

            <!-- Selector de Formato de PDF -->
            <div class="form-group" style="margin-top: 30px;">
                <label class="form-label" style="font-size: 16px; margin-bottom: 15px;">
                    <i class="fas fa-file-pdf" style="color: #dc3545;"></i> Formato de PDF
                </label>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div class="form-check" style="padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px; transition: all 0.3s;">
                        <input class="form-check-input" type="radio" name="Encabezado.TipoFormatoPdf" 
                               id="formatoGDG" value="1" checked style="margin-top: 5px;">
                        <label class="form-check-label" for="formatoGDG" style="cursor: pointer; margin-left: 10px;">
                            <strong>Formato GDG</strong> - Solicitud de D√≠as de Disponibilidad
                            <br>
                            <small style="color: #6c757d;">Grupo Digital de Guatemala</small>
                        </label>
                    </div>
                    <div class="form-check" style="padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px; transition: all 0.3s;">
                        <input class="form-check-input" type="radio" name="Encabezado.TipoFormatoPdf" 
                               id="formatoDigitalGeko" value="2" style="margin-top: 5px;">
                        <label class="form-check-label" for="formatoDigitalGeko" style="cursor: pointer; margin-left: 10px;">
                            <strong>Digital Geko Corp</strong> - Solicitud de D√≠as de Vacaciones
                            <br>
                            <small style="color: #6c757d;">Formato simplificado para Digital Geko Corp S.A.</small>
                        </label>
                    </div>
                </div>
            </div>

            <div class="actions-container">
                <button type="button" class="btn-submit" onclick="mostrarResumen()">
                    <i class="fas fa-check"></i> Confirmar solicitud
                </button>

            </div>

        </form>
    </div>
</div>

<!-- Modal -->
<div class="modal-overlay" id="confirmModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; backdrop-filter: blur(4px);">
    <div class="modal-container" style="max-width:550px; margin:100px auto; background:#fff; border-radius:20px; box-shadow:0 20px 60px rgba(0,0,0,0.3); position:relative; overflow:hidden;">
        <!-- Header con gradiente -->
        <div class="modal-header" style="background:linear-gradient(135deg, #003C9D 0%, #0056D2 100%); color:#fff; padding:24px 30px; display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0; font-size:1.5em; font-weight:600; display:flex; align-items:center; gap:12px;">
                <i class="fas fa-calendar-check"></i>
                Resumen de Solicitud
            </h3>
            <button id="closeModal" style="background:rgba(255,255,255,0.2); border:none; color:#fff; width:36px; height:36px; border-radius:50%; font-size:1.2em; cursor:pointer; transition:all 0.3s; display:flex; align-items:center; justify-content:center;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- Body -->
        <div class="modal-body" style="padding:30px;">
            <div id="resumenSolicitud" style="font-size:1.05em; color:#333; line-height:1.8;"></div>
        </div>
        
        <!-- Footer -->
        <div class="modal-footer" style="background:#f8f9fa; padding:20px 30px; display:flex; justify-content:flex-end; gap:12px; border-top:1px solid #dee2e6;">
            <button type="button" class="btn btn-secondary" id="cancelAction" style="padding:12px 24px; border-radius:10px; font-weight:600; border:none; background:#6c757d; color:#fff; cursor:pointer; transition:all 0.3s;">
                <i class="fas fa-times"></i> Cancelar
            </button>
            <button type="button" class="btn btn-success" id="confirmAction" style="padding:12px 24px; border-radius:10px; font-weight:600; border:none; background:linear-gradient(135deg, #28a745, #20c997); color:#fff; cursor:pointer; transition:all 0.3s; box-shadow:0 4px 12px rgba(40,167,69,0.3);">
                <i class="fa-solid fa-check"></i> Confirmar
            </button>
        </div>
    </div>
</div>
@section Styles {
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 15px;
            line-height: 1.6;
            background-color: #f4f6f9;
        }

        .solicitudes-container {
            background: #ffffff;
            border-radius: 12px;
            padding: 30px 40px;
            max-width: 960px;
            margin: 0 auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
        }

        .page-header {
            background-color: #003C9D;
            padding: 20px 30px;
            border-radius: 12px;
            color: white;
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
        }

        .page-subtitle {
            font-size: 15px;
            opacity: 0.9;
        }

        .form-card {
            background: #fff;
            padding: 30px;
            border-radius: 12px;
        }

        .empleado-info-card .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 15px;
        }

        .form-group label {
            font-weight: 600;
            font-size: 14px;
        }

        .form-control {
            border-radius: 10px;
            padding: 14px 16px;
            font-size: 15px;
            border: 1px solid #ccc;
            transition: all 0.3s ease-in-out;
        }

            .form-control:focus {
                border-color: #003C9D;
                box-shadow: 0 0 6px rgba(0, 60, 157, 0.2);
                outline: none;
            }

        select.form-control {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
            padding-right: 30px;
        }

        .table-container {
            margin: 20px 0;
            background: #fff;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }

        .table {
            width: 100%;
            font-size: 15px;
            border-collapse: separate;
            border-spacing: 0 10px;
        }

            .table th {
                background-color: #003C9D;
                color: white;
                text-align: center;
                padding: 14px;
                font-size: 14px;
                border-radius: 8px 8px 0 0;
            }

            .table td {
                background-color: #ffffff;
                border: 1px solid #dee2e6;
                padding: 12px;
                vertical-align: middle;
                text-align: center;
            }

            .table tr.main-row {
                box-shadow: 0 1px 3px rgba(0,0,0,0.05);
                transition: all 0.2s ease-in-out;
                cursor: pointer;
            }

                .table tr.main-row:hover {
                    background-color: #f1f3f5;
                    transform: scale(1.01);
                }

        .btn-submit,
        .btn-agregar,
        .btn-eliminar {
            font-size: 14px;
            padding: 10px 18px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            transition: all 0.3s ease-in-out;
        }

        .btn-submit {
            background-color: #28a745;
            color: white;
        }

            .btn-submit:hover {
                background-color: #218838;
            }

        .btn-agregar {
            background-color: #0069d9;
            color: white;
        }

            .btn-agregar:hover {
                background-color: #0056b3;
            }

        .btn-eliminar {
            background-color: #dc3545;
            color: white;
        }

            .btn-eliminar:hover {
                background-color: #c82333;
            }

        .actions-container {
            display: flex;
            justify-content: center; /* antes: flex-end */
            margin-top: 20px;
        }


        .form-row {
            display: flex;
            gap: 40px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        .modal-overlay {
            background: rgba(0,0,0,0.6);
        }

        .modal-container {
            background-color: #ffffff;
            padding: 24px 30px;
            border-radius: 16px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            max-width: 520px;
            position: relative;
            margin: 100px auto;
        }

        .modal-header h3 {
            color: white;
            font-weight: bold;
        }

        .modal-footer .btn {
            padding: 10px 20px;
            font-weight: 600;
            border-radius: 8px;
        }

        .modal-footer .btn-success {
            background-color: #28a745;
            border: none;
        }

        .modal-footer .btn-secondary {
            background-color: #6c757d;
            border: none;
        }

        .form-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .form-field {
            flex: 1;
            min-width: 250px;
            display: flex;
            flex-direction: column;
        }


        @@media (max-width: 768px) {
            .form-row

        {
            flex-direction: column;
            gap: 20px;
        }

        .form-card {
            padding: 20px;
        }

        .page-header {
            padding: 20px;
        }

        }

        /* ===== ESTILOS PERSONALIZADOS SWEETALERT2 ===== */
        .swal-error-popup {
            border-radius: 16px !important;
            box-shadow: 0 10px 40px rgba(239, 68, 68, 0.2) !important;
        }

        .swal-error-title {
            color: #DC2626 !important;
            font-size: 1.5rem !important;
            font-weight: 700 !important;
        }

        .swal-error-btn {
            border-radius: 8px !important;
            padding: 10px 24px !important;
            font-weight: 600 !important;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3) !important;
        }

        .swal-error-btn:hover {
            background-color: #DC2626 !important;
            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4) !important;
        }

        .swal-success-popup {
            border-radius: 16px !important;
            box-shadow: 0 10px 40px rgba(16, 185, 129, 0.2) !important;
        }

        .swal-success-title {
            color: #059669 !important;
            font-size: 1.5rem !important;
            font-weight: 700 !important;
        }

        .swal-success-btn {
            border-radius: 8px !important;
            padding: 10px 24px !important;
            font-weight: 600 !important;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3) !important;
        }

        .swal-success-btn:hover {
            background-color: #059669 !important;
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4) !important;
        }

        /* Animaciones */
        .animate__animated {
            animation-duration: 0.5s;
        }

        .animate__faster {
            animation-duration: 0.3s !important;
        }

        /* ===== ESTILOS SWEETALERT2 WARNING ===== */
        .swal-warning-popup {
            border-radius: 16px !important;
            box-shadow: 0 10px 40px rgba(245, 158, 11, 0.2) !important;
        }

        .swal-warning-title {
            color: #D97706 !important;
            font-size: 1.5rem !important;
            font-weight: 700 !important;
        }

        .swal-warning-btn {
            border-radius: 8px !important;
            padding: 10px 24px !important;
            font-weight: 600 !important;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3) !important;
        }

        .swal-warning-btn:hover {
            background-color: #D97706 !important;
            box-shadow: 0 6px 16px rgba(245, 158, 11, 0.4) !important;
        }

        .swal-cancel-btn {
            border-radius: 8px !important;
            padding: 10px 24px !important;
            font-weight: 600 !important;
        }

        .swal-cancel-btn:hover {
            background-color: #4B5563 !important;
        }
    </style>
}


@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.all.min.js"></script>

    <!-- Alertas TempData (jQuery) -->
    <script>
        $(document).ready(function () {
            console.log('Document ready - Verificando mensajes de error...');

            var errorMessage = '@Html.Raw(TempData["ErrorMessage"])';
            console.log('Mensaje de error:', errorMessage);

        @if (ViewBag.DebugInfo != null)
        {
            <text>
                    console.log('=== DEBUG INFO ===');
                    console.log('@Html.Raw(ViewBag.DebugInfo.Replace("\r\n", "\\n").Replace("\n", "\\n"))');
                    console.log('==================');
            </text>
        }

            if (errorMessage && errorMessage !== '') {
                console.log('Mostrando alerta de error...');
                Swal.fire({
                    icon: 'error',
                    title: '¬°Oops! Algo sali√≥ mal',
                    html: `<div style="text-align: left; padding: 10px;">
                            <p style="margin: 0; color: #374151; font-size: 15px; line-height: 1.6;">
                                ${errorMessage}
                            </p>
                           </div>`,
                    confirmButtonColor: '#EF4444',
                    confirmButtonText: '<i class="fas fa-check"></i> Entendido',
                    customClass: {
                        popup: 'swal-error-popup',
                        title: 'swal-error-title',
                        htmlContainer: 'swal-error-html',
                        confirmButton: 'swal-error-btn'
                    },
                    showClass: { popup: 'animate__animated animate__fadeInDown animate__faster' },
                    hideClass: { popup: 'animate__animated animate__fadeOutUp animate__faster' }
                }).then(() => console.log('Alerta cerrada'));
            }

            var infoMessage = '@Html.Raw(TempData["InfoMessage"])';
            if (infoMessage && infoMessage !== '') {
                console.log('Mostrando alerta de informaci√≥n...');
                Swal.fire({
                    icon: 'success',
                    title: '¬°Perfecto!',
                    html: `<div style="text-align: left; padding: 10px;">
                            <p style="margin: 0; color: #374151; font-size: 15px; line-height: 1.6;">
                                ${infoMessage}
                            </p>
                           </div>`,
                    confirmButtonColor: '#10B981',
                    confirmButtonText: '<i class="fas fa-check"></i> Entendido',
                    customClass: {
                        popup: 'swal-success-popup',
                        title: 'swal-success-title',
                        confirmButton: 'swal-success-btn'
                    },
                    showClass: { popup: 'animate__animated animate__bounceIn animate__faster' },
                    hideClass: { popup: 'animate__animated animate__fadeOut animate__faster' }
                });
            }
        });
    </script>

    <!-- L√≥gica principal (rango de fechas, modal, etc.) -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {

            // ===== Datos server =====
            const feriadosData = @Html.Raw(Json.Serialize(ViewBag.Feriados ?? new { }));
            const feriados = Object.keys(feriadosData).reduce((acc, key) => {
                acc[key] = parseFloat(feriadosData[key]);
                return acc;
            }, {});

            const diasDisponibles = @(ViewBag.DiasDisponibles ?? 0);
            console.log('D√≠as disponibles del empleado:', diasDisponibles);

            // ===== Helpers =====
            const parseDateFromInput = (dateStr) => {
                const parts = dateStr.split('-');
                return new Date(parts[0], parts[1] - 1, parts[2]);
            };

            const formatDateLocal = (dateString) => {
                const date = parseDateFromInput(dateString);
                if (isNaN(date)) return dateString;
                const day = date.getDate().toString().padStart(2, '0');
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            };

            const diasEntre = (inicio, fin) => {
                let dias = 0;
                let actual = new Date(parseDateFromInput(inicio));
                const fechaFin = new Date(parseDateFromInput(fin));

                while (actual <= fechaFin) {
                    const diaSemana = actual.getDay();
                    const fechaActualStr = actual.toISOString().split('T')[0];

                    if (diaSemana !== 0 && diaSemana !== 6) { // excluir domingo/s√°bado
                        if (feriados[fechaActualStr]) {
                            dias += (1 - feriados[fechaActualStr]);
                        } else {
                            dias++;
                        }
                    }
                    actual.setDate(actual.getDate() + 1);
                }
                return dias;
            };

            window.rangos = window.rangos || [];

            const traslapa = (inicio, fin) => {
                const nuevoInicio = new Date(parseDateFromInput(inicio));
                const nuevoFin = new Date(parseDateFromInput(fin));

                return window.rangos.some(r => {
                    const existenteInicio = new Date(parseDateFromInput(r.inicio));
                    const existenteFin = new Date(parseDateFromInput(r.fin));
                    return (nuevoInicio <= existenteFin && nuevoFin >= existenteInicio);
                });
            };

            // ===== Render tabla + hidden inputs =====
            window.renderRangos = function () {
                const tbody = document.querySelector('#tablaFechas tbody');
                const detallesContainer = document.getElementById('detallesContainer');

                if (!tbody || !detallesContainer) return;

                tbody.innerHTML = '';
                detallesContainer.innerHTML = '';

                window.rangos.forEach((r, i) => {
                    const fechaInicio = formatDateLocal(r.inicio);
                    const fechaFin = formatDateLocal(r.fin);

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${fechaInicio}</td>
                        <td>${fechaFin}</td>
                        <td>${parseFloat(r.dias).toFixed(2)}</td>
                        <td>
                            <button type="button" class="btn-eliminar" onclick="eliminarRango(${i})">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);

                    detallesContainer.innerHTML += `
                        <input type="hidden" name="Detalles[${i}].FechaInicio" value="${r.inicio}" />
                        <input type="hidden" name="Detalles[${i}].FechaFin" value="${r.fin}" />
                        <input type="hidden" name="Detalles[${i}].DiasHabilesTomados" value="${parseFloat(r.dias).toFixed(2)}" />
                    `;
                });

                const total = window.rangos.reduce((acc, r) => acc + parseFloat(r.dias), 0);
                const totalInput = document.getElementById('TotalDias');
                if (totalInput) totalInput.value = total > 0 ? total.toFixed(2) : '';
            };

            window.eliminarRango = function (idx) {
                window.rangos.splice(idx, 1);
                window.renderRangos();
            };

            // ===== Agregar rango =====
            window.agregarRango = function () {
                const inicio = document.getElementById('NuevaFechaInicio')?.value;
                const fin = document.getElementById('NuevaFechaFin')?.value;

                if (!inicio || !fin) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Campos incompletos',
                        text: 'Debes ingresar ambas fechas.',
                        confirmButtonColor: '#EF4444',
                        confirmButtonText: 'Entendido'
                    });
                    return;
                }

                if (parseDateFromInput(fin) < parseDateFromInput(inicio)) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Rango inv√°lido',
                        text: 'La fecha final no puede ser menor que la inicial.',
                        confirmButtonColor: '#EF4444',
                        confirmButtonText: 'Entendido'
                    });
                    return;
                }

                if (traslapa(inicio, fin)) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Conflicto de fechas',
                        text: 'El rango se traslapa con otro ya agregado.',
                        confirmButtonColor: '#EF4444',
                        confirmButtonText: 'Entendido'
                    });
                    return;
                }

                const calcularYAgregar = () => {
                    const dias = diasEntre(inicio, fin);
                    const totalDiasSolicitados = window.rangos.reduce((sum, r) => sum + parseFloat(r.dias), 0) + dias;

                    if (totalDiasSolicitados > diasDisponibles) {
                        Swal.fire({
                            icon: 'error',
                            title: '‚ùå D√≠as insuficientes',
                            html: `<div style="text-align: left; padding: 10px;">
                                    <p style="margin: 0; color: #374151; font-size: 15px; line-height: 1.6;">
                                        No tienes suficientes d√≠as disponibles.
                                    </p>
                                    <div style="background: #FEE2E2; padding: 12px; border-radius: 8px; margin-top: 12px;">
                                        <p style="margin: 0; color: #991B1B; font-size: 14px;">
                                            <strong>üìä Resumen:</strong><br>
                                            ‚Ä¢ D√≠as que intentas solicitar: <strong>${totalDiasSolicitados.toFixed(2)}</strong><br>
                                            ‚Ä¢ D√≠as disponibles: <strong>${diasDisponibles}</strong><br>
                                            ‚Ä¢ Excedente: <strong style="color: #DC2626;">${(totalDiasSolicitados - diasDisponibles).toFixed(2)}</strong>
                                        </p>
                                    </div>
                                   </div>`,
                            confirmButtonColor: '#EF4444',
                            confirmButtonText: '<i class="fas fa-check"></i> Entendido',
                            customClass: {
                                popup: 'swal-error-popup',
                                title: 'swal-error-title',
                                confirmButton: 'swal-error-btn'
                            }
                        });
                        return;
                    }

                    window.rangos.push({ inicio, fin, dias });
                    window.renderRangos();
                };

                // Confirmaci√≥n si la fecha inicia antes de hoy
                const hoy = new Date();
                hoy.setHours(0, 0, 0, 0);
                const inicioDate = parseDateFromInput(inicio);

                if (inicioDate < hoy) {
                    Swal.fire({
                        icon: 'warning',
                        title: '‚ö†Ô∏è Fecha Anterior Detectada',
                        html: `<div style="text-align: left; padding: 10px;">
                                <p style="margin: 0; color: #374151; font-size: 15px; line-height: 1.6;">
                                    Ha seleccionado un rango con <strong>fecha inicial anterior a hoy</strong>.
                                </p>
                                <p style="margin: 10px 0 0 0; color: #6B7280; font-size: 14px;">
                                    ¬øEst√° seguro de continuar?
                                </p>
                               </div>`,
                        showCancelButton: true,
                        confirmButtonColor: '#F59E0B',
                        cancelButtonColor: '#6B7280',
                        confirmButtonText: '<i class="fas fa-check"></i> S√≠, continuar',
                        cancelButtonText: '<i class="fas fa-times"></i> Cancelar',
                        customClass: {
                            popup: 'swal-warning-popup',
                            title: 'swal-warning-title',
                            confirmButton: 'swal-warning-btn',
                            cancelButton: 'swal-cancel-btn'
                        },
                        showClass: { popup: 'animate__animated animate__headShake animate__faster' },
                        hideClass: { popup: 'animate__animated animate__fadeOut animate__faster' }
                    }).then((result) => {
                        if (result.isConfirmed) calcularYAgregar();
                    });
                    return;
                }

                calcularYAgregar();
            };

            // ===== Modal resumen =====
            window.mostrarResumen = function () {
                if (window.rangos.length === 0) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Sin fechas',
                        text: 'Debes agregar al menos un rango de fechas.',
                        confirmButtonColor: '#EF4444',
                        confirmButtonText: 'Entendido'
                    });
                    return false;
                }

                const totalDias = document.getElementById("TotalDias")?.value || "0";
                const solicitado = document.getElementById("SolicitadoLider")?.value;

                if (!solicitado) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Falta informaci√≥n',
                        text: 'Debes indicar si ya solicitaste a tu l√≠der.',
                        confirmButtonColor: '#EF4444',
                        confirmButtonText: 'Entendido'
                    });
                    return false;
                }

                let resumen = "<ul style='padding-left: 20px;'>";
                window.rangos.forEach(r => {
                    const fi = formatDateLocal(r.inicio);
                    const ff = formatDateLocal(r.fin);
                    resumen += `<li><strong>${fi}</strong> al <strong>${ff}</strong> - ${parseFloat(r.dias).toFixed(2)} d√≠a(s)</li>`;
                });
                resumen += "</ul>";
                resumen += `<p><strong>Total de d√≠as:</strong> ${totalDias}</p>`;
                resumen += `<p><strong>Solicitado al l√≠der:</strong> ${solicitado}</p>`;

                const resumenDiv = document.getElementById("resumenSolicitud");
                const modal = document.getElementById("confirmModal");
                if (resumenDiv) resumenDiv.innerHTML = resumen;
                if (modal) modal.style.display = "block";
            };

            // ===== Botones modal =====
            document.getElementById("cancelAction")?.addEventListener("click", () => {
                document.getElementById("confirmModal").style.display = "none";
            });

            document.getElementById("closeModal")?.addEventListener("click", () => {
                document.getElementById("confirmModal").style.display = "none";
            });

            // Deja SOLO un listener (evita doble submit)
            document.getElementById("confirmAction")?.addEventListener("click", (e) => {
                e.preventDefault();
                document.getElementById("solicitudForm")?.submit();
            });
        });
    </script>

    <!-- Edici√≥n: cargar datos existentes -->
    @if (Model?.Detalles != null && Model.Detalles.Any())
    {
        <script>
            function cargarDatosEdicion() {
                console.log('=== INICIANDO CARGA DE DATOS DE EDICI√ìN ===');

                const rangosExistentes = @Html.Raw(Json.Serialize(Model.Detalles.Select(d => new
                {
                    inicio = d.FechaInicio.ToString("yyyy-MM-dd"),
                    fin = d.FechaFin.ToString("yyyy-MM-dd"),
                    dias = d.DiasHabilesTomados
                })));

                if (window.rangos !== undefined) {
                    window.rangos = rangosExistentes;
                    if (typeof window.renderRangos === 'function') {
                        window.renderRangos();
                        console.log('‚úÖ Rangos cargados:', rangosExistentes);
                    }
                }

            @if (Model?.Encabezado?.IdAutorizador != null)
            {
                <text>
                        const autorizadorSelect = document.getElementById('Autorizador');
                        if (autorizadorSelect) {
                            autorizadorSelect.value = '@Model.Encabezado.IdAutorizador';
                            autorizadorSelect.dispatchEvent(new Event('change'));
                        }
                </text>
            }

            @if (!string.IsNullOrEmpty(Model?.Encabezado?.SolicitudLider))
            {
                <text>
                        const solicitadoLiderSelect = document.getElementById('SolicitadoLider');
                        if (solicitadoLiderSelect) {
                            solicitadoLiderSelect.value = '@Html.Raw(Model.Encabezado.SolicitudLider)';
                            solicitadoLiderSelect.dispatchEvent(new Event('change'));
                        }
                </text>
            }

            @if (!string.IsNullOrEmpty(Model?.Encabezado?.Observaciones))
            {
                <text>
                        const observacionesTextarea = document.getElementById('Observaciones');
                        if (observacionesTextarea) {
                            observacionesTextarea.value = '@Html.Raw(Model.Encabezado.Observaciones.Replace("\r", "").Replace("\n", "\\n").Replace("'", "\\'"))';
                        }
                </text>
            }

                console.log('=== FIN CARGA DE DATOS DE EDICI√ìN ===');
            }

            // Ejecutar
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function () {
                    setTimeout(cargarDatosEdicion, 200);
                });
            } else {
                setTimeout(cargarDatosEdicion, 200);
            }
        </script>
    }
}
