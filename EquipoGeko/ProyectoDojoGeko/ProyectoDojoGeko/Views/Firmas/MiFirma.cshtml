@model ProyectoDojoGeko.Models.FirmaViewModel

@{
    ViewData["Title"] = "Mi Firma Digital";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

<style>
    :root {
        --primary-color: #000878;
        --primary-dark: #000878;
        --success-color: #10B981;
        --danger-color: #EF4444;
        --gray-50: #F9FAFB;
        --gray-100: #F3F4F6;
        --gray-600: #4B5563;
        --gray-700: #374151;
    }

    .firma-container {
        max-width: 900px;
        margin: 2rem auto;
        padding: 0;
    }

    .firma-header {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        color: white;
        padding: 2rem;
        border-radius: 16px 16px 0 0;
        box-shadow: 0 4px 6px rgba(99, 102, 241, 0.1);
    }

    .firma-header h2 {
        margin: 0;
        font-size: 1.75rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .firma-header h2 i {
        font-size: 2rem;
    }

    .firma-content {
        background: white;
        padding: 2rem;
        border-radius: 0 0 16px 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }

    .firma-preview {
        border: 3px dashed #E5E7EB;
        border-radius: 12px;
        padding: 3rem;
        text-align: center;
        background: var(--gray-50);
        min-height: 300px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 2rem;
        transition: all 0.3s ease;
    }

    .firma-preview:hover {
        border-color: var(--primary-color);
        background: #F5F3FF;
    }

    .firma-preview img {
        max-width: 100%;
        max-height: 250px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .firma-preview-empty {
        color: var(--gray-600);
        font-size: 1.125rem;
    }

    .firma-preview-empty i {
        color: var(--gray-600);
        opacity: 0.5;
    }

    .upload-section {
        background: linear-gradient(135deg, #F5F3FF, #EDE9FE);
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 1.5rem;
        border: 1px solid #E9D5FF;
    }

    .upload-section h5 {
        color: var(--gray-700);
        font-weight: 600;
        margin-bottom: 1.5rem;
    }

    .custom-file-upload {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.875rem 2rem;
        cursor: pointer;
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        color: white;
        border-radius: 10px;
        font-weight: 600;
        font-size: 0.9375rem;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    .custom-file-upload:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
    }

    input[type="file"] {
        display: none;
    }

    .file-name {
        margin-top: 1rem;
        padding: 0.875rem 1.25rem;
        background: white;
        border-radius: 8px;
        color: var(--gray-700);
        font-size: 0.875rem;
        border: 1px solid #E5E7EB;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .file-name i {
        color: var(--primary-color);
    }

    .btn-action {
        padding: 0.875rem 2rem;
        font-weight: 600;
        border-radius: 10px;
        transition: all 0.3s ease;
        border: none;
        font-size: 0.9375rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary.btn-action {
        background: linear-gradient(135deg, var(--success-color), #059669);
        color: white;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .btn-primary.btn-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
    }

    .btn-danger.btn-action {
        background: linear-gradient(135deg, var(--danger-color), #DC2626);
        color: white;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    .btn-danger.btn-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
    }

    .info-box {
        background: linear-gradient(135deg, #DBEAFE, #BFDBFE);
        border-left: 4px solid #3B82F6;
        padding: 1.25rem;
        border-radius: 10px;
        margin-bottom: 2rem;
        display: flex;
        align-items: start;
        gap: 0.75rem;
    }

    .info-box i {
        color: #3B82F6;
        font-size: 1.25rem;
        margin-top: 0.125rem;
    }

    .firma-info {
        margin-top: 1.5rem;
        padding: 1rem 1.25rem;
        background: var(--gray-100);
        border-radius: 8px;
        font-size: 0.875rem;
        color: var(--gray-600);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .firma-info i {
        color: var(--primary-color);
    }

    .alert {
        border-radius: 10px;
        border: none;
        padding: 1rem 1.25rem;
        margin-bottom: 1.5rem;
    }

    .alert-success {
        background: linear-gradient(135deg, #D1FAE5, #A7F3D0);
        color: #065F46;
    }

    .alert-danger {
        background: linear-gradient(135deg, #FEE2E2, #FECACA);
        color: #991B1B;
    }

    .buttons-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        margin-top: 1.5rem;
    }
</style>

<div class="firma-container">
    <div class="firma-header">
        <h2>
            <i class="fas fa-signature"></i> Mi Firma Digital
        </h2>
    </div>

    <div class="firma-content">
        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle"></i> @TempData["SuccessMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        @if (TempData["ErrorMessage"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-circle"></i> @TempData["ErrorMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        <div class="info-box">
            <i class="fas fa-info-circle"></i>
            <div>
                <strong>Información:</strong> Tu firma digital se utilizará automáticamente en los PDFs de tus solicitudes de vacaciones.
                Formatos permitidos: JPG, PNG, GIF. Tamaño máximo: 2MB.
            </div>
        </div>

    <!-- Vista previa de la firma -->
    <div class="firma-preview">
        @if (Model?.ImagenFirmaData != null)
        {
            <img src="@Model.ImagenBase64" alt="Mi Firma" id="firmaPreview" />
        }
        else
        {
            <div class="firma-preview-empty">
                <i class="fas fa-image fa-3x mb-3"></i>
                <p>No tienes una firma guardada</p>
            </div>
        }
    </div>

    @if (Model?.FechaActualizacion != null)
    {
        <div class="firma-info">
            <i class="fas fa-clock"></i> 
            <strong>Última actualización:</strong> @Model.FechaActualizacion.Value.ToString("dd/MM/yyyy HH:mm")
        </div>
    }

    <!-- Formulario para subir firma -->
    <form asp-action="SubirFirma" method="post" enctype="multipart/form-data" id="uploadForm">
        @Html.AntiForgeryToken()
        
        <div class="upload-section">
            <h5 class="mb-3">
                <i class="fas fa-upload"></i> 
                @(Model?.ImagenFirmaData != null ? "Actualizar Firma" : "Subir Nueva Firma")
            </h5>
            
            <label for="imagenFirma" class="custom-file-upload">
                <i class="fas fa-cloud-upload-alt"></i> Seleccionar Imagen
            </label>
            <input type="file" 
                   id="imagenFirma" 
                   name="imagenFirma" 
                   accept="image/jpeg,image/jpg,image/png,image/gif" />
            
            <div id="fileName" class="file-name" style="display: none;">
                <i class="fas fa-file-image"></i> 
                <span id="fileNameText"></span>
            </div>
        </div>

        <div class="buttons-container">
            <button type="submit" class="btn btn-primary btn-action" id="btnGuardar" disabled>
                <i class="fas fa-save"></i> Guardar Firma
            </button>

            @if (Model?.ImagenFirmaData != null)
            {
                <button type="button" class="btn btn-danger btn-action" onclick="confirmarEliminar()">
                    <i class="fas fa-trash"></i> Eliminar Firma
                </button>
            }
        </div>
    </form>

        <!-- Formulario oculto para eliminar -->
        @if (Model?.ImagenFirmaData != null)
        {
            <form asp-action="EliminarFirma" method="post" id="formEliminar" style="display: none;">
                @Html.AntiForgeryToken()
            </form>
        }
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Script de firmas cargado');

            // Agregar event listener al input de archivo
            const inputFirma = document.getElementById('imagenFirma');
            if (inputFirma) {
                inputFirma.addEventListener('change', function(e) {
                    previewImage(this);
                });
            }

            function previewImage(input) {
                console.log('previewImage llamado', input.files);
                const fileName = document.getElementById('fileName');
                const fileNameText = document.getElementById('fileNameText');
                const btnGuardar = document.getElementById('btnGuardar');
                const preview = document.getElementById('firmaPreview');

                if (input.files && input.files[0]) {
                    console.log('Archivo seleccionado:', input.files[0].name);
                    
                    // Validar tipo de archivo
                    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
                    if (!allowedTypes.includes(input.files[0].type.toLowerCase())) {
                        alert('Solo se permiten imágenes en formato JPG, PNG o GIF.');
                        input.value = '';
                        return;
                    }

                    // Validar tamaño (2MB)
                    if (input.files[0].size > 2 * 1024 * 1024) {
                        alert('La imagen no debe superar los 2MB.');
                        input.value = '';
                        return;
                    }

                    // Mostrar nombre del archivo
                    fileName.style.display = 'block';
                    fileNameText.textContent = input.files[0].name;
                    btnGuardar.disabled = false;

                    // Previsualizar imagen
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        console.log('Imagen cargada');
                        if (preview) {
                            preview.src = e.target.result;
                        } else {
                            // Si no existe preview, crear uno
                            const previewContainer = document.querySelector('.firma-preview');
                            previewContainer.innerHTML = `<img src="${e.target.result}" alt="Vista previa" id="firmaPreview" />`;
                        }
                    };
                    reader.readAsDataURL(input.files[0]);
                } else {
                    console.log('No hay archivo seleccionado');
                    fileName.style.display = 'none';
                    btnGuardar.disabled = true;
                }
            }

            // Función para confirmar eliminación
            window.confirmarEliminar = function() {
                if (confirm('¿Estás seguro de que deseas eliminar tu firma? Esta acción no se puede deshacer.')) {
                    document.getElementById('formEliminar').submit();
                }
            };

            // Auto-cerrar alertas después de 5 segundos
            setTimeout(function() {
                const alerts = document.querySelectorAll('.alert');
                alerts.forEach(function(alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                });
            }, 5000);
        });
    </script>
}
